
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>taxcalc.calcfunctions &#8212; Tax-Calculator</title>
    
  <link rel="stylesheet" href="../../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.37f24b989f4638ff9c27c22dc7559d4f.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  <img src="../../_static/PSL.svg" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Tax-Calculator</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../index.html">
   Tax-Calculator
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Usage
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../usage/starting.html">
   Getting started
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../usage/overview.html">
   Structural overview
  </a>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../../guide/index.html">
   User guide
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../../guide/python_interface.html">
     Python interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../guide/cli.html">
     Command-line interface
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../guide/policy_params.html">
     Policy parameters
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../guide/input_vars.html">
     Input variables
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../guide/output_vars.html">
     Output variables
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../guide/assumption_params.html">
     Assumption parameters
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../../recipes/index.html">
   Recipes
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../../recipes/recipe00.html">
     Basic Recipe: Static Analysis of a Simple Reform
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../recipes/recipe01.html">
     Recipe 1: Directly Comparing Two Reforms
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../recipes/recipe02.html">
     Recipe 2: Estimating Behavioral Response to Reform
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../recipes/recipe03.html">
     Recipe 3: Creating a Custom Table
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../recipes/recipe04.html">
     Recipe 4: Estimating Differential Reform Response
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../recipes/recipe04_pandas.html">
     Recipe 4: Estimating Differential Reform Response - pandas version
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../recipes/recipe05.html">
     Recipe 5: Redefining Expanded Income
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../recipes/recipe06.html">
     Recipe 6: Analyzing a Non-Parametric Reform
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  About
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../about/history.html">
   History
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../about/roadmap.html">
   Roadmap
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../about/releases.html">
   Release history
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../about/upgrading.html">
   Upgrading to Tax-Calculator 2.0
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../about/license.html">
   License
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Contributing
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../contributing/contributor_guide.html">
   Contributor guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../contributing/pr_workflow.html">
   Pull request workflow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../contributing/param_naming.html">
   Policy parameter naming and placing conventions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../contributing/testing.html">
   Testing
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  API
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1 collapsible-parent">
  <a class="reference internal" href="../../api/public_api.html">
   Tax-Calculator Python API
  </a>
  <ul class="collapse-ul">
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/calcfunctions.html">
     Tax-Calculator CalcFunctions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/calculator.html">
     Tax-Calculator Calculator
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/consumption.html">
     Tax-Calculator Consumption
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/data.html">
     Tax-Calculator Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/decorators.html">
     Tax-Calculator Decorators
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/growdiff.html">
     Tax-Calculator GrowDiff
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/growfactors.html">
     Tax-Calculator GrowFactors
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/parameters.html">
     Tax-Calculator Parameters
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/policy.html">
     Tax-Calculator Policy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/records.html">
     Tax-Calculator Records
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/taxcalcio.html">
     Tax-Calculator IO
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/utils.html">
     Tax-Calculator Utilities
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/utilsprvt.html">
     Tax-Calculator Private Utilities
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../api/calcfunctions.html">
     Tax-Calculator CalcFunctions
    </a>
   </li>
  </ul>
  <i class="fas fa-chevron-down">
  </i>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Tax-Calculator use cases
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../use_cases.html">
   Recorded use cases
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/PSLmodels/Tax-Calculator"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/PSLmodels/Tax-Calculator/issues/new?title=Issue%20on%20page%20%2F_modules/taxcalc/calcfunctions.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                    title="Fullscreen mode"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <h1>Source code for taxcalc.calcfunctions</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Tax-Calculator functions that calculate payroll and individual income taxes.</span>

<span class="sd">These functions are imported into the Calculator class.</span>

<span class="sd">Note: the parameter_indexing_CPI_offset policy parameter is the only</span>
<span class="sd">policy parameter that does not appear here; it is used in the policy.py</span>
<span class="sd">file to possibly adjust the price inflation rate used to index policy</span>
<span class="sd">parameters (as would be done in a reform that introduces chained-CPI</span>
<span class="sd">indexing).</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># CODING-STYLE CHECKS:</span>
<span class="c1"># pycodestyle calcfunctions.py</span>
<span class="c1"># pylint --disable=locally-disabled calcfunctions.py</span>
<span class="c1">#</span>
<span class="c1"># pylint: disable=too-many-lines</span>
<span class="c1"># pylint: disable=invalid-name</span>
<span class="c1"># pylint: disable=too-many-arguments</span>
<span class="c1"># pylint: disable=too-many-locals</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">taxcalc.decorators</span> <span class="kn">import</span> <span class="n">iterate_jit</span><span class="p">,</span> <span class="n">JIT</span>


<div class="viewcode-block" id="BenefitPrograms"><a class="viewcode-back" href="../../api/calcfunctions.html#taxcalc.calcfunctions.BenefitPrograms">[docs]</a><span class="k">def</span> <span class="nf">BenefitPrograms</span><span class="p">(</span><span class="n">calc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate total government cost and consumption value of benefits</span>
<span class="sd">    delivered by non-repealed benefit programs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># zero out benefits delivered by repealed programs</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">array_len</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_housing_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;housing_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_ssi_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;ssi_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_snap_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;snap_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_tanf_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;tanf_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_vet_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;vet_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_wic_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;wic_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_mcare_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcare_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_mcaid_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcaid_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_oasdi_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02400&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_ui_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02300&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;BEN_other_repeal&#39;</span><span class="p">):</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;other_ben&#39;</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
    <span class="c1"># calculate government cost of all benefits</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;housing_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;ssi_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;snap_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;tanf_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;vet_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;wic_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcare_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcaid_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02400&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02300&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;ubi&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;other_ben&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;benefit_cost_total&#39;</span><span class="p">,</span> <span class="n">cost</span><span class="p">)</span>
    <span class="c1"># calculate consumption value of all benefits</span>
    <span class="c1"># (assuming that cash benefits have full value)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;housing_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_housing_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;ssi_ben&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;snap_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_snap_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;tanf_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_tanf_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;vet_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_vet_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;wic_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_wic_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcare_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_mcare_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;mcaid_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_mcaid_value&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02400&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e02300&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;ubi&#39;</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;other_ben&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">consump_param</span><span class="p">(</span><span class="s1">&#39;BEN_other_value&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;benefit_value_total&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">EI_PayrollTax</span><span class="p">(</span><span class="n">SS_Earnings_c</span><span class="p">,</span> <span class="n">e00200p</span><span class="p">,</span> <span class="n">e00200s</span><span class="p">,</span> <span class="n">pencon_p</span><span class="p">,</span> <span class="n">pencon_s</span><span class="p">,</span>
                  <span class="n">FICA_ss_trt</span><span class="p">,</span> <span class="n">FICA_mc_trt</span><span class="p">,</span> <span class="n">ALD_SelfEmploymentTax_hc</span><span class="p">,</span>
                  <span class="n">SS_Earnings_thd</span><span class="p">,</span> <span class="n">e00900p</span><span class="p">,</span> <span class="n">e00900s</span><span class="p">,</span> <span class="n">e02100p</span><span class="p">,</span> <span class="n">e02100s</span><span class="p">,</span> <span class="n">k1bx14p</span><span class="p">,</span>
                  <span class="n">k1bx14s</span><span class="p">,</span> <span class="n">payrolltax</span><span class="p">,</span> <span class="n">ptax_was</span><span class="p">,</span> <span class="n">setax</span><span class="p">,</span> <span class="n">c03260</span><span class="p">,</span> <span class="n">ptax_oasdi</span><span class="p">,</span>
                  <span class="n">sey</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">earned_s</span><span class="p">,</span>
                  <span class="n">was_plus_sey_p</span><span class="p">,</span> <span class="n">was_plus_sey_s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute part of total OASDI+HI payroll taxes and earned income variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># compute sey and its individual components</span>
    <span class="n">sey_p</span> <span class="o">=</span> <span class="n">e00900p</span> <span class="o">+</span> <span class="n">e02100p</span> <span class="o">+</span> <span class="n">k1bx14p</span>
    <span class="n">sey_s</span> <span class="o">=</span> <span class="n">e00900s</span> <span class="o">+</span> <span class="n">e02100s</span> <span class="o">+</span> <span class="n">k1bx14s</span>
    <span class="n">sey</span> <span class="o">=</span> <span class="n">sey_p</span> <span class="o">+</span> <span class="n">sey_s</span>  <span class="c1"># total self-employment income for filing unit</span>

    <span class="c1"># compute gross wage and salary income (&#39;was&#39; denotes &#39;wage and salary&#39;)</span>
    <span class="n">gross_was_p</span> <span class="o">=</span> <span class="n">e00200p</span> <span class="o">+</span> <span class="n">pencon_p</span>
    <span class="n">gross_was_s</span> <span class="o">=</span> <span class="n">e00200s</span> <span class="o">+</span> <span class="n">pencon_s</span>

    <span class="c1"># compute taxable gross earnings for OASDI FICA</span>
    <span class="n">txearn_was_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">SS_Earnings_c</span><span class="p">,</span> <span class="n">gross_was_p</span><span class="p">)</span>
    <span class="n">txearn_was_s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">SS_Earnings_c</span><span class="p">,</span> <span class="n">gross_was_s</span><span class="p">)</span>

    <span class="c1"># compute OASDI and HI payroll taxes on wage-and-salary income, FICA</span>
    <span class="n">ptax_ss_was_p</span> <span class="o">=</span> <span class="n">FICA_ss_trt</span> <span class="o">*</span> <span class="n">txearn_was_p</span>
    <span class="n">ptax_ss_was_s</span> <span class="o">=</span> <span class="n">FICA_ss_trt</span> <span class="o">*</span> <span class="n">txearn_was_s</span>
    <span class="n">ptax_mc_was_p</span> <span class="o">=</span> <span class="n">FICA_mc_trt</span> <span class="o">*</span> <span class="n">gross_was_p</span>
    <span class="n">ptax_mc_was_s</span> <span class="o">=</span> <span class="n">FICA_mc_trt</span> <span class="o">*</span> <span class="n">gross_was_s</span>
    <span class="n">ptax_was</span> <span class="o">=</span> <span class="n">ptax_ss_was_p</span> <span class="o">+</span> <span class="n">ptax_ss_was_s</span> <span class="o">+</span> <span class="n">ptax_mc_was_p</span> <span class="o">+</span> <span class="n">ptax_mc_was_s</span>

    <span class="c1"># compute taxable self-employment income for OASDI SECA</span>
    <span class="n">sey_frac</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">FICA_ss_trt</span> <span class="o">+</span> <span class="n">FICA_mc_trt</span><span class="p">)</span>
    <span class="n">txearn_sey_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_p</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">),</span> <span class="n">SS_Earnings_c</span> <span class="o">-</span> <span class="n">txearn_was_p</span><span class="p">)</span>
    <span class="n">txearn_sey_s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_s</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">),</span> <span class="n">SS_Earnings_c</span> <span class="o">-</span> <span class="n">txearn_was_s</span><span class="p">)</span>

    <span class="c1"># compute self-employment tax on taxable self-employment income, SECA</span>
    <span class="n">setax_ss_p</span> <span class="o">=</span> <span class="n">FICA_ss_trt</span> <span class="o">*</span> <span class="n">txearn_sey_p</span>
    <span class="n">setax_ss_s</span> <span class="o">=</span> <span class="n">FICA_ss_trt</span> <span class="o">*</span> <span class="n">txearn_sey_s</span>
    <span class="n">setax_mc_p</span> <span class="o">=</span> <span class="n">FICA_mc_trt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_p</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">)</span>
    <span class="n">setax_mc_s</span> <span class="o">=</span> <span class="n">FICA_mc_trt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_s</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">)</span>
    <span class="n">setax_p</span> <span class="o">=</span> <span class="n">setax_ss_p</span> <span class="o">+</span> <span class="n">setax_mc_p</span>
    <span class="n">setax_s</span> <span class="o">=</span> <span class="n">setax_ss_s</span> <span class="o">+</span> <span class="n">setax_mc_s</span>
    <span class="n">setax</span> <span class="o">=</span> <span class="n">setax_p</span> <span class="o">+</span> <span class="n">setax_s</span>

    <span class="c1"># compute extra OASDI payroll taxes on the portion of the sum</span>
    <span class="c1"># of wage-and-salary income and taxable self employment income</span>
    <span class="c1"># that exceeds SS_Earnings_thd</span>
    <span class="n">sey_frac</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">FICA_ss_trt</span>
    <span class="n">was_plus_sey_p</span> <span class="o">=</span> <span class="n">gross_was_p</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_p</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">)</span>
    <span class="n">was_plus_sey_s</span> <span class="o">=</span> <span class="n">gross_was_s</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey_s</span> <span class="o">*</span> <span class="n">sey_frac</span><span class="p">)</span>
    <span class="n">extra_ss_income_p</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">was_plus_sey_p</span> <span class="o">-</span> <span class="n">SS_Earnings_thd</span><span class="p">)</span>
    <span class="n">extra_ss_income_s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">was_plus_sey_s</span> <span class="o">-</span> <span class="n">SS_Earnings_thd</span><span class="p">)</span>
    <span class="n">extra_payrolltax</span> <span class="o">=</span> <span class="p">(</span><span class="n">extra_ss_income_p</span> <span class="o">*</span> <span class="n">FICA_ss_trt</span> <span class="o">+</span>
                        <span class="n">extra_ss_income_s</span> <span class="o">*</span> <span class="n">FICA_ss_trt</span><span class="p">)</span>

    <span class="c1"># compute part of total payroll taxes for filing unit</span>
    <span class="c1"># (the ptax_amc part of total payroll taxes for the filing unit is</span>
    <span class="c1"># computed in the AdditionalMedicareTax function below)</span>
    <span class="n">payrolltax</span> <span class="o">=</span> <span class="n">ptax_was</span> <span class="o">+</span> <span class="n">setax</span> <span class="o">+</span> <span class="n">extra_payrolltax</span>

    <span class="c1"># compute OASDI part of payroll taxes</span>
    <span class="n">ptax_oasdi</span> <span class="o">=</span> <span class="p">(</span><span class="n">ptax_ss_was_p</span> <span class="o">+</span> <span class="n">ptax_ss_was_s</span> <span class="o">+</span>
                  <span class="n">setax_ss_p</span> <span class="o">+</span> <span class="n">setax_ss_s</span> <span class="o">+</span>
                  <span class="n">extra_payrolltax</span><span class="p">)</span>

    <span class="c1"># compute earned* variables and AGI deduction for</span>
    <span class="c1"># &quot;employer share&quot; of self-employment tax, c03260</span>
    <span class="c1"># Note: c03260 is the amount on 2015 Form 1040, line 27</span>
    <span class="n">c03260</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_SelfEmploymentTax_hc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">setax</span>
    <span class="n">earned</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00200p</span> <span class="o">+</span> <span class="n">e00200s</span> <span class="o">+</span> <span class="n">sey</span> <span class="o">-</span> <span class="n">c03260</span><span class="p">)</span>
    <span class="n">earned_p</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">e00200p</span> <span class="o">+</span> <span class="n">sey_p</span> <span class="o">-</span>
                        <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_SelfEmploymentTax_hc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">setax_p</span><span class="p">))</span>
    <span class="n">earned_s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">e00200s</span> <span class="o">+</span> <span class="n">sey_s</span> <span class="o">-</span>
                        <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_SelfEmploymentTax_hc</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">setax_s</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">sey</span><span class="p">,</span> <span class="n">payrolltax</span><span class="p">,</span> <span class="n">ptax_was</span><span class="p">,</span> <span class="n">setax</span><span class="p">,</span> <span class="n">c03260</span><span class="p">,</span> <span class="n">ptax_oasdi</span><span class="p">,</span>
            <span class="n">earned</span><span class="p">,</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">earned_s</span><span class="p">,</span> <span class="n">was_plus_sey_p</span><span class="p">,</span> <span class="n">was_plus_sey_s</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">DependentCare</span><span class="p">(</span><span class="n">nu13</span><span class="p">,</span> <span class="n">elderly_dependents</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span>
                  <span class="n">MARS</span><span class="p">,</span> <span class="n">ALD_Dependents_thd</span><span class="p">,</span> <span class="n">ALD_Dependents_hc</span><span class="p">,</span>
                  <span class="n">ALD_Dependents_Child_c</span><span class="p">,</span> <span class="n">ALD_Dependents_Elder_c</span><span class="p">,</span>
                  <span class="n">care_deduction</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes dependent-care above-the-line deduction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nu13: Number of dependents under 13 years old</span>
<span class="sd">    elderly_dependents: number of elderly dependents</span>
<span class="sd">    earned: Form 2441 earned income amount</span>
<span class="sd">    MARS: Marital Status</span>
<span class="sd">    ALD_Dependents_thd: Maximum income to qualify for deduction</span>
<span class="sd">    ALD_Dependents_hc: Deduction for dependent care haircut</span>
<span class="sd">    ALD_Dependents_Child_c: National weighted average cost of childcare</span>
<span class="sd">    ALD_Dependents_Elder_c: Eldercare deduction ceiling</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    care_deduction: Total above the line deductions for dependent care.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">earned</span> <span class="o">&lt;=</span> <span class="n">ALD_Dependents_thd</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">care_deduction</span> <span class="o">=</span> <span class="p">(((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_Dependents_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">nu13</span> <span class="o">*</span>
                           <span class="n">ALD_Dependents_Child_c</span><span class="p">)</span> <span class="o">+</span>
                          <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_Dependents_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">elderly_dependents</span> <span class="o">*</span>
                           <span class="n">ALD_Dependents_Elder_c</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">care_deduction</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">care_deduction</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Adj</span><span class="p">(</span><span class="n">e03150</span><span class="p">,</span> <span class="n">e03210</span><span class="p">,</span> <span class="n">c03260</span><span class="p">,</span>
        <span class="n">e03270</span><span class="p">,</span> <span class="n">e03300</span><span class="p">,</span> <span class="n">e03400</span><span class="p">,</span> <span class="n">e03500</span><span class="p">,</span> <span class="n">e00800</span><span class="p">,</span>
        <span class="n">e03220</span><span class="p">,</span> <span class="n">e03230</span><span class="p">,</span> <span class="n">e03240</span><span class="p">,</span> <span class="n">e03290</span><span class="p">,</span> <span class="n">care_deduction</span><span class="p">,</span>
        <span class="n">ALD_StudentLoan_hc</span><span class="p">,</span> <span class="n">ALD_SelfEmp_HealthIns_hc</span><span class="p">,</span> <span class="n">ALD_KEOGH_SEP_hc</span><span class="p">,</span>
        <span class="n">ALD_EarlyWithdraw_hc</span><span class="p">,</span> <span class="n">ALD_AlimonyPaid_hc</span><span class="p">,</span> <span class="n">ALD_AlimonyReceived_hc</span><span class="p">,</span>
        <span class="n">ALD_EducatorExpenses_hc</span><span class="p">,</span> <span class="n">ALD_HSADeduction_hc</span><span class="p">,</span> <span class="n">ALD_IRAContributions_hc</span><span class="p">,</span>
        <span class="n">ALD_DomesticProduction_hc</span><span class="p">,</span> <span class="n">ALD_Tuition_hc</span><span class="p">,</span>
        <span class="n">c02900</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adj calculates Form 1040 AGI adjustments (i.e., Above-the-Line Deductions).</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Taxpayer characteristics:</span>

<span class="sd">        e03210 : Student loan interest paid</span>

<span class="sd">        e03220 : Educator expenses</span>

<span class="sd">        e03150 : Total deductible IRA plan contributions</span>

<span class="sd">        e03230 : Tuition and fees (Form 8917)</span>

<span class="sd">        e03240 : Domestic production activity deduction (Form 8903)</span>

<span class="sd">        c03260 : Self-employment tax deduction (after haircut)</span>

<span class="sd">        e03270 : Self-employed health insurance premiums</span>

<span class="sd">        e03290 : HSA deduction (Form 8889)</span>

<span class="sd">        e03300 : Total deductible KEOGH/SEP/SIMPLE/etc. plan contributions</span>

<span class="sd">        e03400 : Penalty on early withdrawal of savings deduction</span>

<span class="sd">        e03500 : Alimony paid</span>

<span class="sd">        e00800 : Alimony received</span>

<span class="sd">        care_deduction : Dependent care expense deduction</span>

<span class="sd">    Tax law parameters:</span>

<span class="sd">        ALD_StudentLoan_hc : Student loan interest deduction haircut</span>

<span class="sd">        ALD_SelfEmp_HealthIns_hc : Self-employed h.i. deduction haircut</span>

<span class="sd">        ALD_KEOGH_SEP_hc : KEOGH/etc. plan contribution deduction haircut</span>

<span class="sd">        ALD_EarlyWithdraw_hc : Penalty on early withdrawal deduction haricut</span>

<span class="sd">        ALD_AlimonyPaid_hc : Alimony paid deduction haircut</span>

<span class="sd">        ALD_AlimonyReceived_hc : Alimony received deduction haircut</span>

<span class="sd">        ALD_EducatorExpenses_hc: Eductor expenses haircut</span>

<span class="sd">        ALD_HSADeduction_hc: HSA Deduction haircut</span>

<span class="sd">        ALD_IRAContributions_hc: IRA Contribution haircut</span>

<span class="sd">        ALD_DomesticProduction_hc: Domestic production haircut</span>

<span class="sd">        ALD_Tuition_hc: Tuition and fees haircut</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c02900 : total Form 1040 adjustments, which are not included in AGI</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Form 2555 foreign earned income exclusion is assumed to be zero</span>
    <span class="c1"># Form 1040 adjustments that are included in expanded income:</span>
    <span class="n">c02900</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_StudentLoan_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03210</span> <span class="o">+</span>
              <span class="n">c03260</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_EarlyWithdraw_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03400</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_AlimonyPaid_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03500</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_AlimonyReceived_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e00800</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_EducatorExpenses_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03220</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_Tuition_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03230</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_DomesticProduction_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03240</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_HSADeduction_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03290</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_SelfEmp_HealthIns_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03270</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_IRAContributions_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03150</span> <span class="o">+</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_KEOGH_SEP_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03300</span> <span class="o">+</span>
              <span class="n">care_deduction</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c02900</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ALD_InvInc_ec_base</span><span class="p">(</span><span class="n">p22250</span><span class="p">,</span> <span class="n">p23250</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span>
                       <span class="n">e00300</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span> <span class="n">e01100</span><span class="p">,</span> <span class="n">e01200</span><span class="p">,</span>
                       <span class="n">invinc_ec_base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes invinc_ec_base.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># limitation on net short-term and long-term capital losses</span>
    <span class="n">cgain</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="o">-</span><span class="mf">3000.</span> <span class="o">/</span> <span class="n">sep</span><span class="p">),</span> <span class="n">p22250</span> <span class="o">+</span> <span class="n">p23250</span><span class="p">)</span>
    <span class="c1"># compute exclusion of investment income from AGI</span>
    <span class="n">invinc_ec_base</span> <span class="o">=</span> <span class="n">e00300</span> <span class="o">+</span> <span class="n">e00600</span> <span class="o">+</span> <span class="n">cgain</span> <span class="o">+</span> <span class="n">e01100</span> <span class="o">+</span> <span class="n">e01200</span>
    <span class="k">return</span> <span class="n">invinc_ec_base</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">CapGains</span><span class="p">(</span><span class="n">p23250</span><span class="p">,</span> <span class="n">p22250</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">ALD_StudentLoan_hc</span><span class="p">,</span>
             <span class="n">ALD_InvInc_ec_rt</span><span class="p">,</span> <span class="n">invinc_ec_base</span><span class="p">,</span>
             <span class="n">e00200</span><span class="p">,</span> <span class="n">e00300</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span> <span class="n">e00650</span><span class="p">,</span> <span class="n">e00700</span><span class="p">,</span> <span class="n">e00800</span><span class="p">,</span>
             <span class="n">CG_nodiff</span><span class="p">,</span> <span class="n">CG_ec</span><span class="p">,</span> <span class="n">CG_reinvest_ec_rt</span><span class="p">,</span>
             <span class="n">ALD_BusinessLosses_c</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span>
             <span class="n">e00900</span><span class="p">,</span> <span class="n">e01100</span><span class="p">,</span> <span class="n">e01200</span><span class="p">,</span> <span class="n">e01400</span><span class="p">,</span> <span class="n">e01700</span><span class="p">,</span> <span class="n">e02000</span><span class="p">,</span> <span class="n">e02100</span><span class="p">,</span>
             <span class="n">e02300</span><span class="p">,</span> <span class="n">e00400</span><span class="p">,</span> <span class="n">e02400</span><span class="p">,</span> <span class="n">c02900</span><span class="p">,</span> <span class="n">e03210</span><span class="p">,</span> <span class="n">e03230</span><span class="p">,</span> <span class="n">e03240</span><span class="p">,</span>
             <span class="n">c01000</span><span class="p">,</span> <span class="n">c23650</span><span class="p">,</span> <span class="n">ymod</span><span class="p">,</span> <span class="n">ymod1</span><span class="p">,</span> <span class="n">invinc_agi_ec</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CapGains function: ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># net capital gain (long term + short term) before exclusion</span>
    <span class="n">c23650</span> <span class="o">=</span> <span class="n">p23250</span> <span class="o">+</span> <span class="n">p22250</span>
    <span class="c1"># limitation on capital losses</span>
    <span class="n">c01000</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="o">-</span><span class="mf">3000.</span> <span class="o">/</span> <span class="n">sep</span><span class="p">),</span> <span class="n">c23650</span><span class="p">)</span>
    <span class="c1"># compute total investment income</span>
    <span class="n">invinc</span> <span class="o">=</span> <span class="n">e00300</span> <span class="o">+</span> <span class="n">e00600</span> <span class="o">+</span> <span class="n">c01000</span> <span class="o">+</span> <span class="n">e01100</span> <span class="o">+</span> <span class="n">e01200</span>
    <span class="c1"># compute exclusion of investment income from AGI</span>
    <span class="n">invinc_agi_ec</span> <span class="o">=</span> <span class="n">ALD_InvInc_ec_rt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">invinc_ec_base</span><span class="p">)</span>
    <span class="c1"># compute ymod1 variable that is included in AGI</span>
    <span class="n">ymod1</span> <span class="o">=</span> <span class="p">(</span><span class="n">e00200</span> <span class="o">+</span> <span class="n">e00700</span> <span class="o">+</span> <span class="n">e00800</span> <span class="o">+</span> <span class="n">e01400</span> <span class="o">+</span> <span class="n">e01700</span> <span class="o">+</span>
             <span class="n">invinc</span> <span class="o">-</span> <span class="n">invinc_agi_ec</span> <span class="o">+</span> <span class="n">e02100</span> <span class="o">+</span> <span class="n">e02300</span> <span class="o">+</span>
             <span class="nb">max</span><span class="p">(</span><span class="n">e00900</span> <span class="o">+</span> <span class="n">e02000</span><span class="p">,</span> <span class="o">-</span><span class="n">ALD_BusinessLosses_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">CG_nodiff</span><span class="p">:</span>
        <span class="c1"># apply QDIV+CG exclusion if QDIV+LTCG receive no special tax treatment</span>
        <span class="n">qdcg_pos</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00650</span> <span class="o">+</span> <span class="n">c01000</span><span class="p">)</span>
        <span class="n">qdcg_exclusion</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">CG_ec</span><span class="p">,</span> <span class="n">qdcg_pos</span><span class="p">)</span> <span class="o">+</span>
                          <span class="n">CG_reinvest_ec_rt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">qdcg_pos</span> <span class="o">-</span> <span class="n">CG_ec</span><span class="p">))</span>
        <span class="n">ymod1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ymod1</span> <span class="o">-</span> <span class="n">qdcg_exclusion</span><span class="p">)</span>
        <span class="n">invinc_agi_ec</span> <span class="o">+=</span> <span class="n">qdcg_exclusion</span>
    <span class="c1"># compute ymod variable that is used in OASDI benefit taxation logic</span>
    <span class="n">ymod2</span> <span class="o">=</span> <span class="n">e00400</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.50</span> <span class="o">*</span> <span class="n">e02400</span><span class="p">)</span> <span class="o">-</span> <span class="n">c02900</span>
    <span class="n">ymod3</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ALD_StudentLoan_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e03210</span> <span class="o">+</span> <span class="n">e03230</span> <span class="o">+</span> <span class="n">e03240</span>
    <span class="n">ymod</span> <span class="o">=</span> <span class="n">ymod1</span> <span class="o">+</span> <span class="n">ymod2</span> <span class="o">+</span> <span class="n">ymod3</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c01000</span><span class="p">,</span> <span class="n">c23650</span><span class="p">,</span> <span class="n">ymod</span><span class="p">,</span> <span class="n">ymod1</span><span class="p">,</span> <span class="n">invinc_agi_ec</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">SSBenefits</span><span class="p">(</span><span class="n">MARS</span><span class="p">,</span> <span class="n">ymod</span><span class="p">,</span> <span class="n">e02400</span><span class="p">,</span> <span class="n">SS_thd50</span><span class="p">,</span> <span class="n">SS_thd85</span><span class="p">,</span>
               <span class="n">SS_percentage1</span><span class="p">,</span> <span class="n">SS_percentage2</span><span class="p">,</span> <span class="n">c02500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates OASDI benefits included in AGI, c02500.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ymod</span> <span class="o">&lt;</span> <span class="n">SS_thd50</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">c02500</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">elif</span> <span class="n">ymod</span> <span class="o">&lt;</span> <span class="n">SS_thd85</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">c02500</span> <span class="o">=</span> <span class="n">SS_percentage1</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymod</span> <span class="o">-</span> <span class="n">SS_thd50</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">e02400</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c02500</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">SS_percentage2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymod</span> <span class="o">-</span> <span class="n">SS_thd85</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                     <span class="n">SS_percentage1</span> <span class="o">*</span>
                     <span class="nb">min</span><span class="p">(</span><span class="n">e02400</span><span class="p">,</span> <span class="n">SS_thd85</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                         <span class="n">SS_thd50</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">SS_percentage2</span> <span class="o">*</span> <span class="n">e02400</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c02500</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">UBI</span><span class="p">(</span><span class="n">nu18</span><span class="p">,</span> <span class="n">n1820</span><span class="p">,</span> <span class="n">n21</span><span class="p">,</span> <span class="n">UBI_u18</span><span class="p">,</span> <span class="n">UBI_1820</span><span class="p">,</span> <span class="n">UBI_21</span><span class="p">,</span> <span class="n">UBI_ecrt</span><span class="p">,</span>
        <span class="n">ubi</span><span class="p">,</span> <span class="n">taxable_ubi</span><span class="p">,</span> <span class="n">nontaxable_ubi</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates total and taxable Universal Basic Income (UBI) amount.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nu18: Number of people in the tax unit under 18</span>

<span class="sd">    n1820: Number of people in the tax unit age 18-20</span>

<span class="sd">    n21: Number of people in the tax unit age 21+</span>

<span class="sd">    UBI_u18: UBI benefit for those under 18</span>

<span class="sd">    UBI_1820: UBI benefit for those between 18 to 20</span>

<span class="sd">    UBI_21: UBI benefit for those 21 or more</span>

<span class="sd">    UBI_ecrt: Fraction of UBI benefits that are not included in AGI</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ubi: total UBI received by the tax unit (is included in expanded_income)</span>

<span class="sd">    taxable_ubi: amount of UBI that is taxable (is added to AGI)</span>

<span class="sd">    nontaxable_ubi: amount of UBI that is nontaxable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ubi</span> <span class="o">=</span> <span class="n">nu18</span> <span class="o">*</span> <span class="n">UBI_u18</span> <span class="o">+</span> <span class="n">n1820</span> <span class="o">*</span> <span class="n">UBI_1820</span> <span class="o">+</span> <span class="n">n21</span> <span class="o">*</span> <span class="n">UBI_21</span>
    <span class="n">taxable_ubi</span> <span class="o">=</span> <span class="n">ubi</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">UBI_ecrt</span><span class="p">)</span>
    <span class="n">nontaxable_ubi</span> <span class="o">=</span> <span class="n">ubi</span> <span class="o">-</span> <span class="n">taxable_ubi</span>
    <span class="k">return</span> <span class="n">ubi</span><span class="p">,</span> <span class="n">taxable_ubi</span><span class="p">,</span> <span class="n">nontaxable_ubi</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">AGI</span><span class="p">(</span><span class="n">ymod1</span><span class="p">,</span> <span class="n">c02500</span><span class="p">,</span> <span class="n">c02900</span><span class="p">,</span> <span class="n">XTOT</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">DSI</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="n">nu18</span><span class="p">,</span> <span class="n">taxable_ubi</span><span class="p">,</span>
        <span class="n">II_em</span><span class="p">,</span> <span class="n">II_em_ps</span><span class="p">,</span> <span class="n">II_prt</span><span class="p">,</span> <span class="n">II_no_em_nu18</span><span class="p">,</span>
        <span class="n">c00100</span><span class="p">,</span> <span class="n">pre_c04600</span><span class="p">,</span> <span class="n">c04600</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Adjusted Gross Income (AGI), c00100, and</span>
<span class="sd">    compute personal exemption amount, c04600.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ymod1: float</span>

<span class="sd">    c02500: float</span>

<span class="sd">    c02900: float</span>

<span class="sd">    XTOT: float</span>

<span class="sd">    MARS: int</span>
<span class="sd">        filing status</span>
<span class="sd">    sep: float</span>

<span class="sd">    DSI: float</span>

<span class="sd">    exact: int</span>
<span class="sd">        exact == 1 means do exact calculation, else do smoothed calculation</span>
<span class="sd">        which is used for marginal tax rates</span>
<span class="sd">    nu18: int</span>
<span class="sd">        number of dependents under age 18</span>
<span class="sd">    taxable_ubi: float</span>
<span class="sd">        taxable UBI amount</span>
<span class="sd">    II_em: </span>

<span class="sd">    II_em_ps:</span>

<span class="sd">    II_prt:</span>

<span class="sd">    II_no_em_nu18,</span>

<span class="sd">    c00100: float</span>
<span class="sd">        AGI</span>
<span class="sd">    pre_c04600: float</span>

<span class="sd">    c04600: float</span>
<span class="sd">        exemption amount</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple</span>
<span class="sd">        returns AGI (c00100), (pre_c04600), exemption amount (c04600)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate AGI assuming no foreign earned income exclusion</span>
    <span class="n">c00100</span> <span class="o">=</span> <span class="n">ymod1</span> <span class="o">+</span> <span class="n">c02500</span> <span class="o">-</span> <span class="n">c02900</span> <span class="o">+</span> <span class="n">taxable_ubi</span>
    <span class="c1"># calculate personal exemption amount</span>
    <span class="k">if</span> <span class="n">II_no_em_nu18</span><span class="p">:</span>  <span class="c1"># repeal of personal exemptions for deps. under 18</span>
        <span class="n">pre_c04600</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">XTOT</span> <span class="o">-</span> <span class="n">nu18</span><span class="p">)</span> <span class="o">*</span> <span class="n">II_em</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pre_c04600</span> <span class="o">=</span> <span class="n">XTOT</span> <span class="o">*</span> <span class="n">II_em</span>
    <span class="k">if</span> <span class="n">DSI</span><span class="p">:</span>
        <span class="n">pre_c04600</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># phase-out personal exemption amount</span>
    <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
        <span class="n">line5</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c00100</span> <span class="o">-</span> <span class="n">II_em_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">line6</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">line5</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2500.</span> <span class="o">/</span> <span class="n">sep</span><span class="p">))</span>
        <span class="n">line7</span> <span class="o">=</span> <span class="n">II_prt</span> <span class="o">*</span> <span class="n">line6</span>
        <span class="n">c04600</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">pre_c04600</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">line7</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># smoothed calculation needed for sensible mtr calculation</span>
        <span class="n">dispc_numer</span> <span class="o">=</span> <span class="n">II_prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">II_em_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">dispc_denom</span> <span class="o">=</span> <span class="mf">2500.</span> <span class="o">/</span> <span class="n">sep</span>
        <span class="n">dispc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dispc_numer</span> <span class="o">/</span> <span class="n">dispc_denom</span><span class="p">))</span>
        <span class="n">c04600</span> <span class="o">=</span> <span class="n">pre_c04600</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">dispc</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="n">pre_c04600</span><span class="p">,</span> <span class="n">c04600</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ItemDedCap</span><span class="p">(</span><span class="n">e17500</span><span class="p">,</span> <span class="n">e18400</span><span class="p">,</span> <span class="n">e18500</span><span class="p">,</span> <span class="n">e19200</span><span class="p">,</span> <span class="n">e19800</span><span class="p">,</span> <span class="n">e20100</span><span class="p">,</span> <span class="n">e20400</span><span class="p">,</span> <span class="n">g20500</span><span class="p">,</span>
               <span class="n">c00100</span><span class="p">,</span> <span class="n">ID_AmountCap_rt</span><span class="p">,</span> <span class="n">ID_AmountCap_Switch</span><span class="p">,</span> <span class="n">e17500_capped</span><span class="p">,</span>
               <span class="n">e18400_capped</span><span class="p">,</span> <span class="n">e18500_capped</span><span class="p">,</span> <span class="n">e19200_capped</span><span class="p">,</span> <span class="n">e19800_capped</span><span class="p">,</span>
               <span class="n">e20100_capped</span><span class="p">,</span> <span class="n">e20400_capped</span><span class="p">,</span> <span class="n">g20500_capped</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a cap to gross itemized deductions.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Tax Law Parameters:</span>
<span class="sd">        ID_AmountCap_Switch : Indicator for which itemized deductions are</span>
<span class="sd">                              capped</span>
<span class="sd">        ID_AmountCap_rt : Cap on itemized deductions; decimal fraction of AGI</span>

<span class="sd">    Taxpayer Characteristics:</span>
<span class="sd">        e17500 : Medical expenses</span>

<span class="sd">        e18400 : State and local taxes</span>

<span class="sd">        e18500 : Real-estate taxes</span>

<span class="sd">        e19200 : Interest paid</span>

<span class="sd">        e19800 : Charity cash contributions</span>

<span class="sd">        e20100 : Charity noncash contributions</span>

<span class="sd">        e20400 : Total miscellaneous expenses</span>

<span class="sd">        g20500 : Gross casualty or theft loss (before disregard)</span>

<span class="sd">        c00100: Adjusted Gross Income</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        e17500_capped: Medical expenses, capped by ItemDedCap</span>

<span class="sd">        e18400_capped: State and local taxes, capped by ItemDedCap</span>

<span class="sd">        e18500_capped : Real-estate taxes, capped by ItemDedCap</span>

<span class="sd">        e19200_capped : Interest paid, capped by ItemDedCap</span>

<span class="sd">        e19800_capped : Charity cash contributions, capped by ItemDedCap</span>

<span class="sd">        e20100_capped : Charity noncash contributions, capped by ItemDedCap</span>

<span class="sd">        e20400_capped : Total miscellaneous expenses, capped by ItemDedCap</span>

<span class="sd">        g20500_capped : Gross casualty or theft loss (before disregard),</span>
<span class="sd">                        capped by ItemDedCap</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-branches</span>

    <span class="n">cap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ID_AmountCap_rt</span> <span class="o">*</span> <span class="n">c00100</span><span class="p">)</span>

    <span class="n">gross_ded_amt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># medical</span>
        <span class="n">gross_ded_amt</span> <span class="o">+=</span> <span class="n">e17500</span>
    <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># statelocal</span>
        <span class="n">gross_ded_amt</span> <span class="o">+=</span> <span class="n">e18400</span>
    <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>  <span class="c1"># realestate</span>
        <span class="n">gross_ded_amt</span> <span class="o">+=</span> <span class="n">e18500</span>
    <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>  <span class="c1"># casualty</span>
        <span class="n">gross_ded_amt</span> <span class="o">+=</span> <span class="n">g20500</span>
    <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>  <span class="c1"># misc</span>
        <span class="n">gross_ded_amt</span> <span class="o">+=</span> <span class="n">e20400</span>
    <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># interest</span>
        <span class="n">gross_ded_amt</span> <span class="o">+=</span> <span class="n">e19200</span>
    <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>  <span class="c1"># charity</span>
        <span class="n">gross_ded_amt</span> <span class="o">+=</span> <span class="n">e19800</span> <span class="o">+</span> <span class="n">e20100</span>

    <span class="n">overage</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">gross_ded_amt</span> <span class="o">-</span> <span class="n">cap</span><span class="p">)</span>

    <span class="n">e17500_capped</span> <span class="o">=</span> <span class="n">e17500</span>
    <span class="n">e18400_capped</span> <span class="o">=</span> <span class="n">e18400</span>
    <span class="n">e18500_capped</span> <span class="o">=</span> <span class="n">e18500</span>
    <span class="n">g20500_capped</span> <span class="o">=</span> <span class="n">g20500</span>
    <span class="n">e20400_capped</span> <span class="o">=</span> <span class="n">e20400</span>
    <span class="n">e19200_capped</span> <span class="o">=</span> <span class="n">e19200</span>
    <span class="n">e19800_capped</span> <span class="o">=</span> <span class="n">e19800</span>
    <span class="n">e20100_capped</span> <span class="o">=</span> <span class="n">e20100</span>

    <span class="k">if</span> <span class="n">overage</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># medical</span>
            <span class="n">e17500_capped</span> <span class="o">-=</span> <span class="p">(</span><span class="n">e17500</span> <span class="o">/</span> <span class="n">gross_ded_amt</span><span class="p">)</span> <span class="o">*</span> <span class="n">overage</span>
        <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># statelocal</span>
            <span class="n">e18400_capped</span> <span class="o">-=</span> <span class="p">(</span><span class="n">e18400</span> <span class="o">/</span> <span class="p">(</span><span class="n">gross_ded_amt</span><span class="p">)</span> <span class="o">*</span> <span class="n">overage</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>  <span class="c1"># realestate</span>
            <span class="n">e18500_capped</span> <span class="o">-=</span> <span class="p">(</span><span class="n">e18500</span> <span class="o">/</span> <span class="n">gross_ded_amt</span><span class="p">)</span> <span class="o">*</span> <span class="n">overage</span>
        <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>  <span class="c1"># casualty</span>
            <span class="n">g20500_capped</span> <span class="o">-=</span> <span class="p">(</span><span class="n">g20500</span> <span class="o">/</span> <span class="n">gross_ded_amt</span><span class="p">)</span> <span class="o">*</span> <span class="n">overage</span>
        <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>  <span class="c1"># misc</span>
            <span class="n">e20400_capped</span> <span class="o">-=</span> <span class="p">(</span><span class="n">e20400</span> <span class="o">/</span> <span class="n">gross_ded_amt</span><span class="p">)</span> <span class="o">*</span> <span class="n">overage</span>
        <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># interest</span>
            <span class="n">e19200_capped</span> <span class="o">-=</span> <span class="p">(</span><span class="n">e19200</span> <span class="o">/</span> <span class="n">gross_ded_amt</span><span class="p">)</span> <span class="o">*</span> <span class="n">overage</span>
        <span class="k">if</span> <span class="n">ID_AmountCap_Switch</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>  <span class="c1"># charity</span>
            <span class="n">e19800_capped</span> <span class="o">-=</span> <span class="p">(</span><span class="n">e19800</span> <span class="o">/</span> <span class="n">gross_ded_amt</span><span class="p">)</span> <span class="o">*</span> <span class="n">overage</span>
            <span class="n">e20100_capped</span> <span class="o">-=</span> <span class="p">(</span><span class="n">e20100</span> <span class="o">/</span> <span class="n">gross_ded_amt</span><span class="p">)</span> <span class="o">*</span> <span class="n">overage</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">e17500_capped</span><span class="p">,</span> <span class="n">e18400_capped</span><span class="p">,</span> <span class="n">e18500_capped</span><span class="p">,</span> <span class="n">g20500_capped</span><span class="p">,</span>
            <span class="n">e20400_capped</span><span class="p">,</span> <span class="n">e19200_capped</span><span class="p">,</span> <span class="n">e19800_capped</span><span class="p">,</span> <span class="n">e20100_capped</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ItemDed</span><span class="p">(</span><span class="n">e17500_capped</span><span class="p">,</span> <span class="n">e18400_capped</span><span class="p">,</span> <span class="n">e18500_capped</span><span class="p">,</span> <span class="n">e19200_capped</span><span class="p">,</span>
            <span class="n">e19800_capped</span><span class="p">,</span> <span class="n">e20100_capped</span><span class="p">,</span> <span class="n">e20400_capped</span><span class="p">,</span> <span class="n">g20500_capped</span><span class="p">,</span>
            <span class="n">MARS</span><span class="p">,</span> <span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">c04470</span><span class="p">,</span> <span class="n">c21040</span><span class="p">,</span> <span class="n">c21060</span><span class="p">,</span>
            <span class="n">c17000</span><span class="p">,</span> <span class="n">c18300</span><span class="p">,</span> <span class="n">c19200</span><span class="p">,</span> <span class="n">c19700</span><span class="p">,</span> <span class="n">c20500</span><span class="p">,</span> <span class="n">c20800</span><span class="p">,</span>
            <span class="n">ID_ps</span><span class="p">,</span> <span class="n">ID_Medical_frt</span><span class="p">,</span> <span class="n">ID_Medical_frt_add4aged</span><span class="p">,</span> <span class="n">ID_Medical_hc</span><span class="p">,</span>
            <span class="n">ID_Casualty_frt</span><span class="p">,</span> <span class="n">ID_Casualty_hc</span><span class="p">,</span> <span class="n">ID_Miscellaneous_frt</span><span class="p">,</span>
            <span class="n">ID_Miscellaneous_hc</span><span class="p">,</span> <span class="n">ID_Charity_crt_all</span><span class="p">,</span> <span class="n">ID_Charity_crt_noncash</span><span class="p">,</span>
            <span class="n">ID_prt</span><span class="p">,</span> <span class="n">ID_crt</span><span class="p">,</span> <span class="n">ID_c</span><span class="p">,</span> <span class="n">ID_StateLocalTax_hc</span><span class="p">,</span> <span class="n">ID_Charity_frt</span><span class="p">,</span>
            <span class="n">ID_Charity_hc</span><span class="p">,</span> <span class="n">ID_InterestPaid_hc</span><span class="p">,</span> <span class="n">ID_RealEstate_hc</span><span class="p">,</span>
            <span class="n">ID_Medical_c</span><span class="p">,</span> <span class="n">ID_StateLocalTax_c</span><span class="p">,</span> <span class="n">ID_RealEstate_c</span><span class="p">,</span>
            <span class="n">ID_InterestPaid_c</span><span class="p">,</span> <span class="n">ID_Charity_c</span><span class="p">,</span> <span class="n">ID_Casualty_c</span><span class="p">,</span>
            <span class="n">ID_Miscellaneous_c</span><span class="p">,</span> <span class="n">ID_AllTaxes_c</span><span class="p">,</span> <span class="n">ID_AllTaxes_hc</span><span class="p">,</span>
            <span class="n">ID_StateLocalTax_crt</span><span class="p">,</span> <span class="n">ID_RealEstate_crt</span><span class="p">,</span> <span class="n">ID_Charity_f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates itemized deductions, Form 1040, Schedule A.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Tax Law Parameters:</span>
<span class="sd">        ID_ps : Itemized deduction phaseout AGI start (Pease)</span>

<span class="sd">        ID_crt : Itemized deduction maximum phaseout</span>
<span class="sd">                 as a decimal fraction of total itemized deduction (Pease)</span>

<span class="sd">        ID_prt : Itemized deduction phaseout rate (Pease)</span>

<span class="sd">        ID_c: Dollar limit on itemized deductions</span>

<span class="sd">        ID_Medical_frt : Deduction for medical expenses;</span>
<span class="sd">                         floor as a decimal fraction of AGI</span>

<span class="sd">        ID_Medical_frt_add4aged : Addon for medical expenses deduction for</span>
<span class="sd">                                  elderly; addon as a decimal fraction of AGI</span>

<span class="sd">        ID_Casualty_frt : Deduction for casualty loss;</span>
<span class="sd">                          floor as a decimal fraction of AGI</span>

<span class="sd">        ID_Miscellaneous_frt : Deduction for miscellaneous expenses;</span>
<span class="sd">                               floor as a decimal fraction of AGI</span>

<span class="sd">        ID_Charity_crt_all : Deduction for all charitable contributions;</span>
<span class="sd">                             ceiling as a decimal fraction of AGI</span>

<span class="sd">        ID_Charity_crt_noncash : Deduction for noncash charitable</span>
<span class="sd">                                 contributions; ceiling as a decimal</span>
<span class="sd">                                 fraction of AGI</span>

<span class="sd">        ID_Charity_frt : Disregard for charitable contributions;</span>
<span class="sd">                         floor as a decimal fraction of AGI</span>

<span class="sd">        ID_Medical_c : Ceiling on medical expense deduction</span>

<span class="sd">        ID_StateLocalTax_c : Ceiling on state and local tax deduction</span>

<span class="sd">        ID_RealEstate_c : Ceiling on real estate tax deduction</span>

<span class="sd">        ID_AllTaxes_c: Ceiling combined state and local income/sales and</span>
<span class="sd">                       real estate tax deductions</span>

<span class="sd">        ID_InterestPaid_c : Ceiling on interest paid deduction</span>

<span class="sd">        ID_Charity_c : Ceiling on charity expense deduction</span>

<span class="sd">        ID_Charity_f: Floor on charity expense deduction</span>

<span class="sd">        ID_Casualty_c : Ceiling on casuality expense deduction</span>

<span class="sd">        ID_Miscellaneous_c : Ceiling on miscellaneous expense deduction</span>

<span class="sd">        ID_StateLocalTax_crt : Deduction for state and local taxes;</span>
<span class="sd">                               ceiling as a decimal fraction of AGI</span>

<span class="sd">        ID_RealEstate_crt : Deduction for real estate taxes;</span>
<span class="sd">                            ceiling as a decimal fraction of AGI</span>

<span class="sd">    Taxpayer Characteristics:</span>
<span class="sd">        e17500_capped : Medical expenses, capped by ItemDedCap</span>

<span class="sd">        e18400_capped : State and local taxes, capped by ItemDedCap</span>

<span class="sd">        e18500_capped : Real-estate taxes, capped by ItemDedCap</span>

<span class="sd">        e19200_capped : Interest paid, capped by ItemDedCap</span>

<span class="sd">        e19800_capped : Charity cash contributions, capped by ItemDedCap</span>

<span class="sd">        e20100_capped : Charity noncash contributions, capped by ItemDedCap</span>

<span class="sd">        e20400_capped : Total miscellaneous expenses, capped by ItemDedCap</span>

<span class="sd">        g20500_capped : Gross casualty or theft loss (before disregard),</span>
<span class="sd">                        capped by ItemDedCap</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c04470 : total itemized deduction amount (and other intermediate variables)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">posagi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="c1"># Medical</span>
    <span class="n">medical_frt</span> <span class="o">=</span> <span class="n">ID_Medical_frt</span>
    <span class="k">if</span> <span class="n">age_head</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="ow">or</span> <span class="p">(</span><span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">):</span>
        <span class="n">medical_frt</span> <span class="o">+=</span> <span class="n">ID_Medical_frt_add4aged</span>
    <span class="n">c17750</span> <span class="o">=</span> <span class="n">medical_frt</span> <span class="o">*</span> <span class="n">posagi</span>
    <span class="n">c17000</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e17500_capped</span> <span class="o">-</span> <span class="n">c17750</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_Medical_hc</span><span class="p">)</span>
    <span class="n">c17000</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c17000</span><span class="p">,</span> <span class="n">ID_Medical_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># State and local taxes</span>
    <span class="n">c18400</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_StateLocalTax_hc</span><span class="p">)</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">e18400_capped</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                 <span class="n">ID_StateLocalTax_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">c18500</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_RealEstate_hc</span><span class="p">)</span> <span class="o">*</span> <span class="n">e18500_capped</span><span class="p">,</span>
                 <span class="n">ID_RealEstate_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># following two statements implement a cap on c18400 and c18500 in a way</span>
    <span class="c1"># that those with negative AGI, c00100, are not capped under current law,</span>
    <span class="c1"># hence the 0.0001 rather than zero</span>
    <span class="n">c18400</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c18400</span><span class="p">,</span> <span class="n">ID_StateLocalTax_crt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">))</span>
    <span class="n">c18500</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c18500</span><span class="p">,</span> <span class="n">ID_RealEstate_crt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">))</span>
    <span class="n">c18300</span> <span class="o">=</span> <span class="p">(</span><span class="n">c18400</span> <span class="o">+</span> <span class="n">c18500</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_AllTaxes_hc</span><span class="p">)</span>
    <span class="n">c18300</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c18300</span><span class="p">,</span> <span class="n">ID_AllTaxes_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Interest paid</span>
    <span class="n">c19200</span> <span class="o">=</span> <span class="n">e19200_capped</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_InterestPaid_hc</span><span class="p">)</span>
    <span class="n">c19200</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c19200</span><span class="p">,</span> <span class="n">ID_InterestPaid_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Charity</span>
    <span class="n">lim30</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ID_Charity_crt_noncash</span> <span class="o">*</span> <span class="n">posagi</span><span class="p">,</span> <span class="n">e20100_capped</span><span class="p">)</span>
    <span class="n">c19700</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ID_Charity_crt_all</span> <span class="o">*</span> <span class="n">posagi</span><span class="p">,</span> <span class="n">lim30</span> <span class="o">+</span> <span class="n">e19800_capped</span><span class="p">)</span>
    <span class="c1"># charity floor is zero in present law</span>
    <span class="n">charity_floor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ID_Charity_frt</span> <span class="o">*</span> <span class="n">posagi</span><span class="p">,</span> <span class="n">ID_Charity_f</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">c19700</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c19700</span> <span class="o">-</span> <span class="n">charity_floor</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_Charity_hc</span><span class="p">)</span>
    <span class="n">c19700</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c19700</span><span class="p">,</span> <span class="n">ID_Charity_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Casualty</span>
    <span class="n">c20500</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">g20500_capped</span> <span class="o">-</span> <span class="n">ID_Casualty_frt</span> <span class="o">*</span> <span class="n">posagi</span><span class="p">)</span> <span class="o">*</span>
              <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_Casualty_hc</span><span class="p">))</span>
    <span class="n">c20500</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c20500</span><span class="p">,</span> <span class="n">ID_Casualty_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Miscellaneous</span>
    <span class="n">c20400</span> <span class="o">=</span> <span class="n">e20400_capped</span>
    <span class="n">c20750</span> <span class="o">=</span> <span class="n">ID_Miscellaneous_frt</span> <span class="o">*</span> <span class="n">posagi</span>
    <span class="n">c20800</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c20400</span> <span class="o">-</span> <span class="n">c20750</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ID_Miscellaneous_hc</span><span class="p">)</span>
    <span class="n">c20800</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c20800</span><span class="p">,</span> <span class="n">ID_Miscellaneous_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Gross total itemized deductions</span>
    <span class="n">c21060</span> <span class="o">=</span> <span class="n">c17000</span> <span class="o">+</span> <span class="n">c18300</span> <span class="o">+</span> <span class="n">c19200</span> <span class="o">+</span> <span class="n">c19700</span> <span class="o">+</span> <span class="n">c20500</span> <span class="o">+</span> <span class="n">c20800</span>
    <span class="c1"># Limitations on total itemized deductions</span>
    <span class="c1"># (no attempt to adjust c04470 components for limitations)</span>
    <span class="n">nonlimited</span> <span class="o">=</span> <span class="n">c17000</span> <span class="o">+</span> <span class="n">c20500</span>
    <span class="n">limitstart</span> <span class="o">=</span> <span class="n">ID_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">c21060</span> <span class="o">&gt;</span> <span class="n">nonlimited</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="n">limitstart</span><span class="p">:</span>
        <span class="n">dedmin</span> <span class="o">=</span> <span class="n">ID_crt</span> <span class="o">*</span> <span class="p">(</span><span class="n">c21060</span> <span class="o">-</span> <span class="n">nonlimited</span><span class="p">)</span>
        <span class="n">dedpho</span> <span class="o">=</span> <span class="n">ID_prt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">posagi</span> <span class="o">-</span> <span class="n">limitstart</span><span class="p">)</span>
        <span class="n">c21040</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dedmin</span><span class="p">,</span> <span class="n">dedpho</span><span class="p">)</span>
        <span class="n">c04470</span> <span class="o">=</span> <span class="n">c21060</span> <span class="o">-</span> <span class="n">c21040</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c21040</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">c04470</span> <span class="o">=</span> <span class="n">c21060</span>
    <span class="n">c04470</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c04470</span><span class="p">,</span> <span class="n">ID_c</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Return total itemized deduction amounts and components</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c17000</span><span class="p">,</span> <span class="n">c18300</span><span class="p">,</span> <span class="n">c19200</span><span class="p">,</span> <span class="n">c19700</span><span class="p">,</span> <span class="n">c20500</span><span class="p">,</span> <span class="n">c20800</span><span class="p">,</span>
            <span class="n">c21040</span><span class="p">,</span> <span class="n">c21060</span><span class="p">,</span> <span class="n">c04470</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">AdditionalMedicareTax</span><span class="p">(</span><span class="n">e00200</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span>
                          <span class="n">AMEDT_ec</span><span class="p">,</span> <span class="n">sey</span><span class="p">,</span> <span class="n">AMEDT_rt</span><span class="p">,</span>
                          <span class="n">FICA_mc_trt</span><span class="p">,</span> <span class="n">FICA_ss_trt</span><span class="p">,</span>
                          <span class="n">ptax_amc</span><span class="p">,</span> <span class="n">payrolltax</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Additional Medicare Tax (Form 8959) included in payroll taxes.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Tax Law Parameters:</span>
<span class="sd">        AMEDT_ec : Additional Medicare Tax earnings exclusion</span>

<span class="sd">        AMEDT_rt : Additional Medicare Tax rate</span>

<span class="sd">        FICA_ss_trt : FICA Social Security tax rate</span>

<span class="sd">        FICA_mc_trt : FICA Medicare tax rate</span>

<span class="sd">    Taxpayer Charateristics:</span>
<span class="sd">        e00200 : Wages and salaries</span>

<span class="sd">        sey : Self-employment income</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ptax_amc : Additional Medicare Tax</span>

<span class="sd">    payrolltax : payroll tax augmented by Additional Medicare Tax</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line8</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sey</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">FICA_mc_trt</span> <span class="o">+</span> <span class="n">FICA_ss_trt</span><span class="p">))</span>
    <span class="n">line11</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">AMEDT_ec</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">e00200</span><span class="p">)</span>
    <span class="n">ptax_amc</span> <span class="o">=</span> <span class="n">AMEDT_rt</span> <span class="o">*</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00200</span> <span class="o">-</span> <span class="n">AMEDT_ec</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
                           <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line8</span> <span class="o">-</span> <span class="n">line11</span><span class="p">))</span>
    <span class="n">payrolltax</span> <span class="o">+=</span> <span class="n">ptax_amc</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ptax_amc</span><span class="p">,</span> <span class="n">payrolltax</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">StdDed</span><span class="p">(</span><span class="n">DSI</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span> <span class="n">STD</span><span class="p">,</span> <span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">STD_Aged</span><span class="p">,</span> <span class="n">STD_Dep</span><span class="p">,</span>
           <span class="n">MARS</span><span class="p">,</span> <span class="n">MIDR</span><span class="p">,</span> <span class="n">blind_head</span><span class="p">,</span> <span class="n">blind_spouse</span><span class="p">,</span> <span class="n">standard</span><span class="p">,</span> <span class="n">c19700</span><span class="p">,</span>
           <span class="n">STD_allow_charity_ded_nonitemizers</span><span class="p">,</span>
           <span class="n">STD_charity_ded_nonitemizers_max</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates standard deduction, including standard deduction for</span>
<span class="sd">    dependents, aged and bind.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Tax Law Parameters:</span>
<span class="sd">        STD : Standard deduction amount, filing status dependent</span>

<span class="sd">        STD_Dep : Standard deduction for dependents</span>

<span class="sd">        STD_Aged : Additional standard deduction for blind and aged</span>

<span class="sd">    Taxpayer Characteristics:</span>
<span class="sd">        earned : Form 2441 earned income amount</span>

<span class="sd">        e02400 : Gross Social Security Benefit</span>

<span class="sd">        DSI : Dependent Status Indicator:</span>
<span class="sd">            0 - not being claimed as a dependent</span>
<span class="sd">            1 - claimed as a dependent</span>

<span class="sd">        MIDR : Married filing separately itemized deductions</span>
<span class="sd">        requirement indicator:</span>
<span class="sd">            0 - not necessary to itemize because of filing status</span>
<span class="sd">            1 - necessary to itemize when filing separately</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    standard : the standard deduction amount for filing unit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate deduction for dependents</span>
    <span class="k">if</span> <span class="n">DSI</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">c15100</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">350.</span> <span class="o">+</span> <span class="n">earned</span><span class="p">,</span> <span class="n">STD_Dep</span><span class="p">)</span>
        <span class="n">basic_stded</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">STD</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c15100</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c15100</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">MIDR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">basic_stded</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">basic_stded</span> <span class="o">=</span> <span class="n">STD</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># calculate extra standard deduction for aged and blind</span>
    <span class="n">num_extra_stded</span> <span class="o">=</span> <span class="n">blind_head</span> <span class="o">+</span> <span class="n">blind_spouse</span>
    <span class="k">if</span> <span class="n">age_head</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">:</span>
        <span class="n">num_extra_stded</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">:</span>
        <span class="n">num_extra_stded</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">extra_stded</span> <span class="o">=</span> <span class="n">num_extra_stded</span> <span class="o">*</span> <span class="n">STD_Aged</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># calculate the total standard deduction</span>
    <span class="n">standard</span> <span class="o">=</span> <span class="n">basic_stded</span> <span class="o">+</span> <span class="n">extra_stded</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">MIDR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">standard</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">STD_allow_charity_ded_nonitemizers</span><span class="p">:</span>
        <span class="n">standard</span> <span class="o">+=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c19700</span><span class="p">,</span> <span class="n">STD_charity_ded_nonitemizers_max</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">standard</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">TaxInc</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="n">standard</span><span class="p">,</span> <span class="n">c04470</span><span class="p">,</span> <span class="n">c04600</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">e00900</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span>
           <span class="n">e02100</span><span class="p">,</span> <span class="n">e27200</span><span class="p">,</span> <span class="n">e00650</span><span class="p">,</span> <span class="n">c01000</span><span class="p">,</span> <span class="n">PT_SSTB_income</span><span class="p">,</span>
           <span class="n">PT_binc_w2_wages</span><span class="p">,</span> <span class="n">PT_ubia_property</span><span class="p">,</span> <span class="n">PT_qbid_rt</span><span class="p">,</span>
           <span class="n">PT_qbid_taxinc_thd</span><span class="p">,</span> <span class="n">PT_qbid_taxinc_gap</span><span class="p">,</span> <span class="n">PT_qbid_w2_wages_rt</span><span class="p">,</span>
           <span class="n">PT_qbid_alt_w2_wages_rt</span><span class="p">,</span> <span class="n">PT_qbid_alt_property_rt</span><span class="p">,</span> <span class="n">c04800</span><span class="p">,</span>
           <span class="n">PT_qbid_ps</span><span class="p">,</span> <span class="n">PT_qbid_prt</span><span class="p">,</span> <span class="n">qbided</span><span class="p">,</span> <span class="n">PT_qbid_limit_switch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates taxable income, c04800, and</span>
<span class="sd">    qualified business income deduction, qbided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate taxable income before qualified business income deduction</span>
    <span class="n">pre_qbid_taxinc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c00100</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">c04470</span><span class="p">,</span> <span class="n">standard</span><span class="p">)</span> <span class="o">-</span> <span class="n">c04600</span><span class="p">)</span>
    <span class="c1"># calculate qualified business income deduction</span>
    <span class="n">qbided</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">qbinc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00900</span> <span class="o">+</span> <span class="n">e26270</span> <span class="o">+</span> <span class="n">e02100</span> <span class="o">+</span> <span class="n">e27200</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">qbinc</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">PT_qbid_rt</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">qbid_before_limits</span> <span class="o">=</span> <span class="n">qbinc</span> <span class="o">*</span> <span class="n">PT_qbid_rt</span>
        <span class="n">lower_thd</span> <span class="o">=</span> <span class="n">PT_qbid_taxinc_thd</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pre_qbid_taxinc</span> <span class="o">&lt;=</span> <span class="n">lower_thd</span><span class="p">:</span>
            <span class="n">qbided</span> <span class="o">=</span> <span class="n">qbid_before_limits</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pre_qbid_taxinc_gap</span> <span class="o">=</span> <span class="n">PT_qbid_taxinc_gap</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">upper_thd</span> <span class="o">=</span> <span class="n">lower_thd</span> <span class="o">+</span> <span class="n">pre_qbid_taxinc_gap</span>
            <span class="k">if</span> <span class="n">PT_SSTB_income</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">pre_qbid_taxinc</span> <span class="o">&gt;=</span> <span class="n">upper_thd</span><span class="p">:</span>
                <span class="n">qbided</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="c1"># if PT_qbid_limit_switch is True, apply wage/capital</span>
            <span class="c1"># limitations.</span>
            <span class="k">elif</span> <span class="n">PT_qbid_limit_switch</span><span class="p">:</span>
                <span class="n">wage_cap</span> <span class="o">=</span> <span class="n">PT_binc_w2_wages</span> <span class="o">*</span> <span class="n">PT_qbid_w2_wages_rt</span>
                <span class="n">alt_cap</span> <span class="o">=</span> <span class="p">(</span><span class="n">PT_binc_w2_wages</span> <span class="o">*</span> <span class="n">PT_qbid_alt_w2_wages_rt</span> <span class="o">+</span>
                           <span class="n">PT_ubia_property</span> <span class="o">*</span> <span class="n">PT_qbid_alt_property_rt</span><span class="p">)</span>
                <span class="n">full_cap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">wage_cap</span><span class="p">,</span> <span class="n">alt_cap</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">PT_SSTB_income</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pre_qbid_taxinc</span> <span class="o">&gt;=</span> <span class="n">upper_thd</span><span class="p">:</span>
                    <span class="c1"># apply full cap</span>
                    <span class="n">qbided</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">full_cap</span><span class="p">,</span> <span class="n">qbid_before_limits</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">PT_SSTB_income</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pre_qbid_taxinc</span> <span class="o">&lt;</span> <span class="n">upper_thd</span><span class="p">:</span>
                    <span class="c1"># apply adjusted cap as in Part III of Worksheet 12-A</span>
                    <span class="c1"># in 2018 IRS Publication 535 (Chapter 12)</span>
                    <span class="n">prt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre_qbid_taxinc</span> <span class="o">-</span> <span class="n">lower_thd</span><span class="p">)</span> <span class="o">/</span> <span class="n">pre_qbid_taxinc_gap</span>
                    <span class="n">adj</span> <span class="o">=</span> <span class="n">prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">qbid_before_limits</span> <span class="o">-</span> <span class="n">full_cap</span><span class="p">)</span>
                    <span class="n">qbided</span> <span class="o">=</span> <span class="n">qbid_before_limits</span> <span class="o">-</span> <span class="n">adj</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># PT_SSTB_income == 1 and pre_qbid_taxinc &lt; upper_thd</span>
                    <span class="n">prti</span> <span class="o">=</span> <span class="p">(</span><span class="n">upper_thd</span> <span class="o">-</span> <span class="n">pre_qbid_taxinc</span><span class="p">)</span> <span class="o">/</span> <span class="n">pre_qbid_taxinc_gap</span>
                    <span class="n">qbid_adjusted</span> <span class="o">=</span> <span class="n">prti</span> <span class="o">*</span> <span class="n">qbid_before_limits</span>
                    <span class="n">cap_adjusted</span> <span class="o">=</span> <span class="n">prti</span> <span class="o">*</span> <span class="n">full_cap</span>
                    <span class="n">prt</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre_qbid_taxinc</span> <span class="o">-</span> <span class="n">lower_thd</span><span class="p">)</span> <span class="o">/</span> <span class="n">pre_qbid_taxinc_gap</span>
                    <span class="n">adj</span> <span class="o">=</span> <span class="n">prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">qbid_adjusted</span> <span class="o">-</span> <span class="n">cap_adjusted</span><span class="p">)</span>
                    <span class="n">qbided</span> <span class="o">=</span> <span class="n">qbid_adjusted</span> <span class="o">-</span> <span class="n">adj</span>
            <span class="c1"># if PT_qbid_limit_switch is False, assume all taxpayers</span>
            <span class="c1"># have sufficient wage expenses and capital income to avoid</span>
            <span class="c1"># QBID limitations.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qbided</span> <span class="o">=</span> <span class="n">qbid_before_limits</span>
        <span class="c1"># apply taxinc cap (assuning cap rate is equal to PT_qbid_rt)</span>
        <span class="n">net_cg</span> <span class="o">=</span> <span class="n">e00650</span> <span class="o">+</span> <span class="n">c01000</span>  <span class="c1"># per line 34 in 2018 Pub 535 Worksheet 12-A</span>
        <span class="n">taxinc_cap</span> <span class="o">=</span> <span class="n">PT_qbid_rt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">pre_qbid_taxinc</span> <span class="o">-</span> <span class="n">net_cg</span><span class="p">)</span>
        <span class="n">qbided</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">qbided</span><span class="p">,</span> <span class="n">taxinc_cap</span><span class="p">)</span>

        <span class="c1"># apply qbid phaseout</span>
        <span class="k">if</span> <span class="n">qbided</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">pre_qbid_taxinc</span> <span class="o">&gt;</span> <span class="n">PT_qbid_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">excess</span> <span class="o">=</span> <span class="n">pre_qbid_taxinc</span> <span class="o">-</span> <span class="n">PT_qbid_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">qbided</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">qbided</span> <span class="o">-</span> <span class="n">PT_qbid_prt</span> <span class="o">*</span> <span class="n">excess</span><span class="p">)</span>

    <span class="c1"># calculate taxable income after qualified business income deduction</span>
    <span class="n">c04800</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">pre_qbid_taxinc</span> <span class="o">-</span> <span class="n">qbided</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c04800</span><span class="p">,</span> <span class="n">qbided</span><span class="p">)</span>


<div class="viewcode-block" id="SchXYZ"><a class="viewcode-back" href="../../api/calcfunctions.html#taxcalc.calcfunctions.SchXYZ">[docs]</a><span class="nd">@JIT</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">SchXYZ</span><span class="p">(</span><span class="n">taxable_income</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">e00900</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span> <span class="n">e02000</span><span class="p">,</span> <span class="n">e00200</span><span class="p">,</span>
           <span class="n">PT_rt1</span><span class="p">,</span> <span class="n">PT_rt2</span><span class="p">,</span> <span class="n">PT_rt3</span><span class="p">,</span> <span class="n">PT_rt4</span><span class="p">,</span> <span class="n">PT_rt5</span><span class="p">,</span>
           <span class="n">PT_rt6</span><span class="p">,</span> <span class="n">PT_rt7</span><span class="p">,</span> <span class="n">PT_rt8</span><span class="p">,</span>
           <span class="n">PT_brk1</span><span class="p">,</span> <span class="n">PT_brk2</span><span class="p">,</span> <span class="n">PT_brk3</span><span class="p">,</span> <span class="n">PT_brk4</span><span class="p">,</span> <span class="n">PT_brk5</span><span class="p">,</span>
           <span class="n">PT_brk6</span><span class="p">,</span> <span class="n">PT_brk7</span><span class="p">,</span>
           <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span> <span class="n">II_rt5</span><span class="p">,</span>
           <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span>
           <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span> <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span>
           <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span><span class="p">,</span> <span class="n">PT_EligibleRate_active</span><span class="p">,</span>
           <span class="n">PT_EligibleRate_passive</span><span class="p">,</span> <span class="n">PT_wages_active_income</span><span class="p">,</span>
           <span class="n">PT_top_stacking</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns Schedule X, Y, Z tax amount for specified taxable_income.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># separate non-negative taxable income into two non-negative components,</span>
    <span class="c1"># doing this in a way so that the components add up to taxable income</span>
    <span class="c1"># define pass-through income eligible for PT schedule</span>
    <span class="n">pt_passive</span> <span class="o">=</span> <span class="n">PT_EligibleRate_passive</span> <span class="o">*</span> <span class="p">(</span><span class="n">e02000</span> <span class="o">-</span> <span class="n">e26270</span><span class="p">)</span>
    <span class="n">pt_active_gross</span> <span class="o">=</span> <span class="n">e00900</span> <span class="o">+</span> <span class="n">e26270</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pt_active_gross</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">PT_wages_active_income</span><span class="p">:</span>
        <span class="n">pt_active_gross</span> <span class="o">=</span> <span class="n">pt_active_gross</span> <span class="o">+</span> <span class="n">e00200</span>
    <span class="n">pt_active</span> <span class="o">=</span> <span class="n">PT_EligibleRate_active</span> <span class="o">*</span> <span class="n">pt_active_gross</span>
    <span class="n">pt_active</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pt_active</span><span class="p">,</span> <span class="n">e00900</span> <span class="o">+</span> <span class="n">e26270</span><span class="p">)</span>
    <span class="n">pt_taxinc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">pt_passive</span> <span class="o">+</span> <span class="n">pt_active</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pt_taxinc</span> <span class="o">&gt;=</span> <span class="n">taxable_income</span><span class="p">:</span>
        <span class="n">pt_taxinc</span> <span class="o">=</span> <span class="n">taxable_income</span>
        <span class="n">reg_taxinc</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># pt_taxinc is unchanged</span>
        <span class="n">reg_taxinc</span> <span class="o">=</span> <span class="n">taxable_income</span> <span class="o">-</span> <span class="n">pt_taxinc</span>
    <span class="c1"># determine stacking order</span>
    <span class="k">if</span> <span class="n">PT_top_stacking</span><span class="p">:</span>
        <span class="n">reg_tbase</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">pt_tbase</span> <span class="o">=</span> <span class="n">reg_taxinc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reg_tbase</span> <span class="o">=</span> <span class="n">pt_taxinc</span>
        <span class="n">pt_tbase</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># compute Schedule X,Y,Z tax using the two components of taxable income</span>
    <span class="k">if</span> <span class="n">reg_taxinc</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">reg_tax</span> <span class="o">=</span> <span class="n">Taxes</span><span class="p">(</span><span class="n">reg_taxinc</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">reg_tbase</span><span class="p">,</span>
                        <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span>
                        <span class="n">II_rt5</span><span class="p">,</span> <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span> <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span>
                        <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span> <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">reg_tax</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">if</span> <span class="n">pt_taxinc</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">pt_tax</span> <span class="o">=</span> <span class="n">Taxes</span><span class="p">(</span><span class="n">pt_taxinc</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">pt_tbase</span><span class="p">,</span>
                       <span class="n">PT_rt1</span><span class="p">,</span> <span class="n">PT_rt2</span><span class="p">,</span> <span class="n">PT_rt3</span><span class="p">,</span> <span class="n">PT_rt4</span><span class="p">,</span>
                       <span class="n">PT_rt5</span><span class="p">,</span> <span class="n">PT_rt6</span><span class="p">,</span> <span class="n">PT_rt7</span><span class="p">,</span> <span class="n">PT_rt8</span><span class="p">,</span> <span class="n">PT_brk1</span><span class="p">,</span> <span class="n">PT_brk2</span><span class="p">,</span>
                       <span class="n">PT_brk3</span><span class="p">,</span> <span class="n">PT_brk4</span><span class="p">,</span> <span class="n">PT_brk5</span><span class="p">,</span> <span class="n">PT_brk6</span><span class="p">,</span> <span class="n">PT_brk7</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pt_tax</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">reg_tax</span> <span class="o">+</span> <span class="n">pt_tax</span></div>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">SchXYZTax</span><span class="p">(</span><span class="n">c04800</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">e00900</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span> <span class="n">e02000</span><span class="p">,</span> <span class="n">e00200</span><span class="p">,</span>
              <span class="n">PT_rt1</span><span class="p">,</span> <span class="n">PT_rt2</span><span class="p">,</span> <span class="n">PT_rt3</span><span class="p">,</span> <span class="n">PT_rt4</span><span class="p">,</span> <span class="n">PT_rt5</span><span class="p">,</span>
              <span class="n">PT_rt6</span><span class="p">,</span> <span class="n">PT_rt7</span><span class="p">,</span> <span class="n">PT_rt8</span><span class="p">,</span>
              <span class="n">PT_brk1</span><span class="p">,</span> <span class="n">PT_brk2</span><span class="p">,</span> <span class="n">PT_brk3</span><span class="p">,</span> <span class="n">PT_brk4</span><span class="p">,</span> <span class="n">PT_brk5</span><span class="p">,</span>
              <span class="n">PT_brk6</span><span class="p">,</span> <span class="n">PT_brk7</span><span class="p">,</span>
              <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span> <span class="n">II_rt5</span><span class="p">,</span>
              <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span>
              <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span> <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span>
              <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span><span class="p">,</span> <span class="n">PT_EligibleRate_active</span><span class="p">,</span>
              <span class="n">PT_EligibleRate_passive</span><span class="p">,</span> <span class="n">PT_wages_active_income</span><span class="p">,</span>
              <span class="n">PT_top_stacking</span><span class="p">,</span> <span class="n">c05200</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SchXYZTax calls SchXYZ function and sets c05200 to returned amount.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c05200</span> <span class="o">=</span> <span class="n">SchXYZ</span><span class="p">(</span><span class="n">c04800</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">e00900</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span> <span class="n">e02000</span><span class="p">,</span> <span class="n">e00200</span><span class="p">,</span>
                    <span class="n">PT_rt1</span><span class="p">,</span> <span class="n">PT_rt2</span><span class="p">,</span> <span class="n">PT_rt3</span><span class="p">,</span> <span class="n">PT_rt4</span><span class="p">,</span> <span class="n">PT_rt5</span><span class="p">,</span>
                    <span class="n">PT_rt6</span><span class="p">,</span> <span class="n">PT_rt7</span><span class="p">,</span> <span class="n">PT_rt8</span><span class="p">,</span>
                    <span class="n">PT_brk1</span><span class="p">,</span> <span class="n">PT_brk2</span><span class="p">,</span> <span class="n">PT_brk3</span><span class="p">,</span> <span class="n">PT_brk4</span><span class="p">,</span> <span class="n">PT_brk5</span><span class="p">,</span>
                    <span class="n">PT_brk6</span><span class="p">,</span> <span class="n">PT_brk7</span><span class="p">,</span>
                    <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span> <span class="n">II_rt5</span><span class="p">,</span>
                    <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span>
                    <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span> <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span>
                    <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span><span class="p">,</span> <span class="n">PT_EligibleRate_active</span><span class="p">,</span>
                    <span class="n">PT_EligibleRate_passive</span><span class="p">,</span> <span class="n">PT_wages_active_income</span><span class="p">,</span>
                    <span class="n">PT_top_stacking</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c05200</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">GainsTax</span><span class="p">(</span><span class="n">e00650</span><span class="p">,</span> <span class="n">c01000</span><span class="p">,</span> <span class="n">c23650</span><span class="p">,</span> <span class="n">p23250</span><span class="p">,</span> <span class="n">e01100</span><span class="p">,</span> <span class="n">e58990</span><span class="p">,</span> <span class="n">e00200</span><span class="p">,</span>
             <span class="n">e24515</span><span class="p">,</span> <span class="n">e24518</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">c04800</span><span class="p">,</span> <span class="n">c05200</span><span class="p">,</span> <span class="n">e00900</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span> <span class="n">e02000</span><span class="p">,</span>
             <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span> <span class="n">II_rt5</span><span class="p">,</span> <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span>
             <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span> <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span> <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span><span class="p">,</span>
             <span class="n">PT_rt1</span><span class="p">,</span> <span class="n">PT_rt2</span><span class="p">,</span> <span class="n">PT_rt3</span><span class="p">,</span> <span class="n">PT_rt4</span><span class="p">,</span> <span class="n">PT_rt5</span><span class="p">,</span> <span class="n">PT_rt6</span><span class="p">,</span> <span class="n">PT_rt7</span><span class="p">,</span> <span class="n">PT_rt8</span><span class="p">,</span>
             <span class="n">PT_brk1</span><span class="p">,</span> <span class="n">PT_brk2</span><span class="p">,</span> <span class="n">PT_brk3</span><span class="p">,</span> <span class="n">PT_brk4</span><span class="p">,</span> <span class="n">PT_brk5</span><span class="p">,</span> <span class="n">PT_brk6</span><span class="p">,</span> <span class="n">PT_brk7</span><span class="p">,</span>
             <span class="n">CG_nodiff</span><span class="p">,</span> <span class="n">PT_EligibleRate_active</span><span class="p">,</span> <span class="n">PT_EligibleRate_passive</span><span class="p">,</span>
             <span class="n">PT_wages_active_income</span><span class="p">,</span> <span class="n">PT_top_stacking</span><span class="p">,</span>
             <span class="n">CG_rt1</span><span class="p">,</span> <span class="n">CG_rt2</span><span class="p">,</span> <span class="n">CG_rt3</span><span class="p">,</span> <span class="n">CG_rt4</span><span class="p">,</span> <span class="n">CG_brk1</span><span class="p">,</span> <span class="n">CG_brk2</span><span class="p">,</span> <span class="n">CG_brk3</span><span class="p">,</span>
             <span class="n">dwks10</span><span class="p">,</span> <span class="n">dwks13</span><span class="p">,</span> <span class="n">dwks14</span><span class="p">,</span> <span class="n">dwks19</span><span class="p">,</span> <span class="n">c05700</span><span class="p">,</span> <span class="n">taxbc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GainsTax function implements (2015) Schedule D Tax Worksheet logic for</span>
<span class="sd">    the special taxation of long-term capital gains and qualified dividends</span>
<span class="sd">    if CG_nodiff is false.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-statements</span>
    <span class="k">if</span> <span class="n">c01000</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">c23650</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">p23250</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">e01100</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">e00650</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">hasqdivltcg</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># has qualified dividends or long-term capital gains</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hasqdivltcg</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># no qualified dividends or long-term capital gains</span>

    <span class="k">if</span> <span class="n">CG_nodiff</span><span class="p">:</span>
        <span class="n">hasqdivltcg</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># no special taxation of qual divids and l-t cap gains</span>

    <span class="k">if</span> <span class="n">hasqdivltcg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

        <span class="n">dwks1</span> <span class="o">=</span> <span class="n">c04800</span>
        <span class="n">dwks2</span> <span class="o">=</span> <span class="n">e00650</span>
        <span class="n">dwks3</span> <span class="o">=</span> <span class="n">e58990</span>
        <span class="n">dwks4</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># always assumed to be zero</span>
        <span class="n">dwks5</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks3</span> <span class="o">-</span> <span class="n">dwks4</span><span class="p">)</span>
        <span class="n">dwks6</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks2</span> <span class="o">-</span> <span class="n">dwks5</span><span class="p">)</span>
        <span class="n">dwks7</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p23250</span><span class="p">,</span> <span class="n">c23650</span><span class="p">)</span>  <span class="c1"># SchD lines 15 and 16, respectively</span>
        <span class="c1"># dwks8 = min(dwks3, dwks4)</span>
        <span class="c1"># dwks9 = max(0., dwks7 - dwks8)</span>
        <span class="c1"># BELOW TWO STATEMENTS ARE UNCLEAR IN LIGHT OF dwks9=... COMMENT</span>
        <span class="k">if</span> <span class="n">e01100</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">c24510</span> <span class="o">=</span> <span class="n">e01100</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c24510</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks7</span><span class="p">)</span> <span class="o">+</span> <span class="n">e01100</span>
        <span class="n">dwks9</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c24510</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e58990</span><span class="p">))</span>
        <span class="c1"># ABOVE TWO STATEMENTS ARE UNCLEAR IN LIGHT OF dwks9=... COMMENT</span>
        <span class="n">dwks10</span> <span class="o">=</span> <span class="n">dwks6</span> <span class="o">+</span> <span class="n">dwks9</span>
        <span class="n">dwks11</span> <span class="o">=</span> <span class="n">e24515</span> <span class="o">+</span> <span class="n">e24518</span>  <span class="c1"># SchD lines 18 and 19, respectively</span>
        <span class="n">dwks12</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks9</span><span class="p">,</span> <span class="n">dwks11</span><span class="p">)</span>
        <span class="n">dwks13</span> <span class="o">=</span> <span class="n">dwks10</span> <span class="o">-</span> <span class="n">dwks12</span>
        <span class="n">dwks14</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks1</span> <span class="o">-</span> <span class="n">dwks13</span><span class="p">)</span>
        <span class="n">dwks16</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CG_brk1</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dwks1</span><span class="p">)</span>
        <span class="n">dwks17</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks14</span><span class="p">,</span> <span class="n">dwks16</span><span class="p">)</span>
        <span class="n">dwks18</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks1</span> <span class="o">-</span> <span class="n">dwks10</span><span class="p">)</span>
        <span class="n">dwks19</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dwks17</span><span class="p">,</span> <span class="n">dwks18</span><span class="p">)</span>
        <span class="n">dwks20</span> <span class="o">=</span> <span class="n">dwks16</span> <span class="o">-</span> <span class="n">dwks17</span>
        <span class="n">lowest_rate_tax</span> <span class="o">=</span> <span class="n">CG_rt1</span> <span class="o">*</span> <span class="n">dwks20</span>
        <span class="c1"># break in worksheet lines</span>
        <span class="n">dwks21</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks1</span><span class="p">,</span> <span class="n">dwks13</span><span class="p">)</span>
        <span class="n">dwks22</span> <span class="o">=</span> <span class="n">dwks20</span>
        <span class="n">dwks23</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks21</span> <span class="o">-</span> <span class="n">dwks22</span><span class="p">)</span>
        <span class="n">dwks25</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CG_brk2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dwks1</span><span class="p">)</span>
        <span class="n">dwks26</span> <span class="o">=</span> <span class="n">dwks19</span> <span class="o">+</span> <span class="n">dwks20</span>
        <span class="n">dwks27</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks25</span> <span class="o">-</span> <span class="n">dwks26</span><span class="p">)</span>
        <span class="n">dwks28</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks23</span><span class="p">,</span> <span class="n">dwks27</span><span class="p">)</span>
        <span class="n">dwks29</span> <span class="o">=</span> <span class="n">CG_rt2</span> <span class="o">*</span> <span class="n">dwks28</span>
        <span class="n">dwks30</span> <span class="o">=</span> <span class="n">dwks22</span> <span class="o">+</span> <span class="n">dwks28</span>
        <span class="n">dwks31</span> <span class="o">=</span> <span class="n">dwks21</span> <span class="o">-</span> <span class="n">dwks30</span>
        <span class="n">dwks32</span> <span class="o">=</span> <span class="n">CG_rt3</span> <span class="o">*</span> <span class="n">dwks31</span>
        <span class="c1"># compute total taxable CG for additional top bracket</span>
        <span class="n">cg_all</span> <span class="o">=</span> <span class="n">dwks20</span> <span class="o">+</span> <span class="n">dwks28</span> <span class="o">+</span> <span class="n">dwks31</span>
        <span class="n">hi_base</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">cg_all</span> <span class="o">-</span> <span class="n">CG_brk3</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">hi_incremental_rate</span> <span class="o">=</span> <span class="n">CG_rt4</span> <span class="o">-</span> <span class="n">CG_rt3</span>
        <span class="n">highest_rate_incremental_tax</span> <span class="o">=</span> <span class="n">hi_incremental_rate</span> <span class="o">*</span> <span class="n">hi_base</span>
        <span class="c1"># break in worksheet lines</span>
        <span class="n">dwks33</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks9</span><span class="p">,</span> <span class="n">e24515</span><span class="p">)</span>
        <span class="n">dwks34</span> <span class="o">=</span> <span class="n">dwks10</span> <span class="o">+</span> <span class="n">dwks19</span>
        <span class="n">dwks36</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks34</span> <span class="o">-</span> <span class="n">dwks1</span><span class="p">)</span>
        <span class="n">dwks37</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">dwks33</span> <span class="o">-</span> <span class="n">dwks36</span><span class="p">)</span>
        <span class="n">dwks38</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">dwks37</span>
        <span class="c1"># break in worksheet lines</span>
        <span class="n">dwks39</span> <span class="o">=</span> <span class="n">dwks19</span> <span class="o">+</span> <span class="n">dwks20</span> <span class="o">+</span> <span class="n">dwks28</span> <span class="o">+</span> <span class="n">dwks31</span> <span class="o">+</span> <span class="n">dwks37</span>
        <span class="n">dwks40</span> <span class="o">=</span> <span class="n">dwks1</span> <span class="o">-</span> <span class="n">dwks39</span>
        <span class="n">dwks41</span> <span class="o">=</span> <span class="mf">0.28</span> <span class="o">*</span> <span class="n">dwks40</span>
        <span class="n">dwks42</span> <span class="o">=</span> <span class="n">SchXYZ</span><span class="p">(</span><span class="n">dwks19</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">e00900</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span> <span class="n">e02000</span><span class="p">,</span> <span class="n">e00200</span><span class="p">,</span>
                        <span class="n">PT_rt1</span><span class="p">,</span> <span class="n">PT_rt2</span><span class="p">,</span> <span class="n">PT_rt3</span><span class="p">,</span> <span class="n">PT_rt4</span><span class="p">,</span> <span class="n">PT_rt5</span><span class="p">,</span>
                        <span class="n">PT_rt6</span><span class="p">,</span> <span class="n">PT_rt7</span><span class="p">,</span> <span class="n">PT_rt8</span><span class="p">,</span>
                        <span class="n">PT_brk1</span><span class="p">,</span> <span class="n">PT_brk2</span><span class="p">,</span> <span class="n">PT_brk3</span><span class="p">,</span> <span class="n">PT_brk4</span><span class="p">,</span> <span class="n">PT_brk5</span><span class="p">,</span>
                        <span class="n">PT_brk6</span><span class="p">,</span> <span class="n">PT_brk7</span><span class="p">,</span>
                        <span class="n">II_rt1</span><span class="p">,</span> <span class="n">II_rt2</span><span class="p">,</span> <span class="n">II_rt3</span><span class="p">,</span> <span class="n">II_rt4</span><span class="p">,</span> <span class="n">II_rt5</span><span class="p">,</span>
                        <span class="n">II_rt6</span><span class="p">,</span> <span class="n">II_rt7</span><span class="p">,</span> <span class="n">II_rt8</span><span class="p">,</span>
                        <span class="n">II_brk1</span><span class="p">,</span> <span class="n">II_brk2</span><span class="p">,</span> <span class="n">II_brk3</span><span class="p">,</span> <span class="n">II_brk4</span><span class="p">,</span> <span class="n">II_brk5</span><span class="p">,</span>
                        <span class="n">II_brk6</span><span class="p">,</span> <span class="n">II_brk7</span><span class="p">,</span> <span class="n">PT_EligibleRate_active</span><span class="p">,</span>
                        <span class="n">PT_EligibleRate_passive</span><span class="p">,</span> <span class="n">PT_wages_active_income</span><span class="p">,</span>
                        <span class="n">PT_top_stacking</span><span class="p">)</span>
        <span class="n">dwks43</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwks29</span> <span class="o">+</span> <span class="n">dwks32</span> <span class="o">+</span> <span class="n">dwks38</span> <span class="o">+</span> <span class="n">dwks41</span> <span class="o">+</span> <span class="n">dwks42</span> <span class="o">+</span>
                  <span class="n">lowest_rate_tax</span> <span class="o">+</span> <span class="n">highest_rate_incremental_tax</span><span class="p">)</span>
        <span class="n">dwks44</span> <span class="o">=</span> <span class="n">c05200</span>
        <span class="n">dwks45</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">dwks43</span><span class="p">,</span> <span class="n">dwks44</span><span class="p">)</span>
        <span class="n">c24580</span> <span class="o">=</span> <span class="n">dwks45</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if hasqdivltcg is zero</span>

        <span class="n">c24580</span> <span class="o">=</span> <span class="n">c05200</span>
        <span class="n">dwks10</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">p23250</span><span class="p">,</span> <span class="n">c23650</span><span class="p">))</span> <span class="o">+</span> <span class="n">e01100</span>
        <span class="n">dwks13</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dwks14</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">dwks19</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># final calculations done no matter what the value of hasqdivltcg</span>
    <span class="n">c05100</span> <span class="o">=</span> <span class="n">c24580</span>  <span class="c1"># because foreign earned income exclusion is assumed zero</span>
    <span class="n">c05700</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># no Form 4972, Lump Sum Distributions</span>
    <span class="n">taxbc</span> <span class="o">=</span> <span class="n">c05700</span> <span class="o">+</span> <span class="n">c05100</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">dwks10</span><span class="p">,</span> <span class="n">dwks13</span><span class="p">,</span> <span class="n">dwks14</span><span class="p">,</span> <span class="n">dwks19</span><span class="p">,</span> <span class="n">c05700</span><span class="p">,</span> <span class="n">taxbc</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">AGIsurtax</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">AGI_surtax_trt</span><span class="p">,</span> <span class="n">AGI_surtax_thd</span><span class="p">,</span> <span class="n">taxbc</span><span class="p">,</span> <span class="n">surtax</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes surtax on AGI above some threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">AGI_surtax_trt</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">hiAGItax</span> <span class="o">=</span> <span class="n">AGI_surtax_trt</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">AGI_surtax_thd</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">taxbc</span> <span class="o">+=</span> <span class="n">hiAGItax</span>
        <span class="n">surtax</span> <span class="o">+=</span> <span class="n">hiAGItax</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">taxbc</span><span class="p">,</span> <span class="n">surtax</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">AMT</span><span class="p">(</span><span class="n">e07300</span><span class="p">,</span> <span class="n">dwks13</span><span class="p">,</span> <span class="n">standard</span><span class="p">,</span> <span class="n">f6251</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">c18300</span><span class="p">,</span> <span class="n">taxbc</span><span class="p">,</span>
        <span class="n">c04470</span><span class="p">,</span> <span class="n">c17000</span><span class="p">,</span> <span class="n">c20800</span><span class="p">,</span> <span class="n">c21040</span><span class="p">,</span> <span class="n">e24515</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">dwks19</span><span class="p">,</span>
        <span class="n">dwks14</span><span class="p">,</span> <span class="n">c05700</span><span class="p">,</span> <span class="n">e62900</span><span class="p">,</span> <span class="n">e00700</span><span class="p">,</span> <span class="n">dwks10</span><span class="p">,</span> <span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span>
        <span class="n">earned</span><span class="p">,</span> <span class="n">cmbtp</span><span class="p">,</span>
        <span class="n">AMT_child_em_c_age</span><span class="p">,</span> <span class="n">AMT_brk1</span><span class="p">,</span>
        <span class="n">AMT_em</span><span class="p">,</span> <span class="n">AMT_prt</span><span class="p">,</span> <span class="n">AMT_rt1</span><span class="p">,</span> <span class="n">AMT_rt2</span><span class="p">,</span>
        <span class="n">AMT_child_em</span><span class="p">,</span> <span class="n">AMT_em_ps</span><span class="p">,</span> <span class="n">AMT_em_pe</span><span class="p">,</span>
        <span class="n">AMT_CG_brk1</span><span class="p">,</span> <span class="n">AMT_CG_brk2</span><span class="p">,</span> <span class="n">AMT_CG_brk3</span><span class="p">,</span> <span class="n">AMT_CG_rt1</span><span class="p">,</span> <span class="n">AMT_CG_rt2</span><span class="p">,</span>
        <span class="n">AMT_CG_rt3</span><span class="p">,</span> <span class="n">AMT_CG_rt4</span><span class="p">,</span> <span class="n">c05800</span><span class="p">,</span> <span class="n">c09600</span><span class="p">,</span> <span class="n">c62100</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Alternative Minimum Tax (AMT) taxable income and liability, where</span>
<span class="sd">    c62100 is AMT taxable income,</span>
<span class="sd">    c09600 is AMT tax liability, and</span>
<span class="sd">    c05800 is total (regular + AMT) income tax liability before credits.</span>

<span class="sd">    Note that line-number variable names refer to 2015 Form 6251.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-statements,too-many-branches</span>
    <span class="c1"># Form 6251, Part I</span>
    <span class="k">if</span> <span class="n">standard</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">c62100</span> <span class="o">=</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">e00700</span> <span class="o">-</span> <span class="n">c04470</span> <span class="o">+</span>
                  <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">c17000</span><span class="p">,</span> <span class="mf">0.025</span> <span class="o">*</span> <span class="n">c00100</span><span class="p">))</span> <span class="o">+</span>
                  <span class="n">c18300</span> <span class="o">+</span> <span class="n">c20800</span> <span class="o">-</span> <span class="n">c21040</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">standard</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">c62100</span> <span class="o">=</span> <span class="n">c00100</span> <span class="o">-</span> <span class="n">e00700</span>
    <span class="n">c62100</span> <span class="o">+=</span> <span class="n">cmbtp</span>  <span class="c1"># add income not in AGI but considered income for AMT</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">amtsepadd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span>
                        <span class="nb">min</span><span class="p">(</span><span class="n">AMT_em</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">AMT_prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">c62100</span> <span class="o">-</span> <span class="n">AMT_em_pe</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">amtsepadd</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">c62100</span> <span class="o">=</span> <span class="n">c62100</span> <span class="o">+</span> <span class="n">amtsepadd</span>  <span class="c1"># AMT taxable income, which is line28</span>
    <span class="c1"># Form 6251, Part II top</span>
    <span class="n">line29</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">AMT_em</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">AMT_prt</span> <span class="o">*</span>
                 <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c62100</span> <span class="o">-</span> <span class="n">AMT_em_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">young_head</span> <span class="o">=</span> <span class="n">age_head</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">age_head</span> <span class="o">&lt;</span> <span class="n">AMT_child_em_c_age</span>
    <span class="n">no_or_young_spouse</span> <span class="o">=</span> <span class="n">age_spouse</span> <span class="o">&lt;</span> <span class="n">AMT_child_em_c_age</span>
    <span class="k">if</span> <span class="n">young_head</span> <span class="ow">and</span> <span class="n">no_or_young_spouse</span><span class="p">:</span>
        <span class="n">line29</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line29</span><span class="p">,</span> <span class="n">earned</span> <span class="o">+</span> <span class="n">AMT_child_em</span><span class="p">)</span>
    <span class="n">line30</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c62100</span> <span class="o">-</span> <span class="n">line29</span><span class="p">)</span>
    <span class="n">line3163</span> <span class="o">=</span> <span class="p">(</span><span class="n">AMT_rt1</span> <span class="o">*</span> <span class="n">line30</span> <span class="o">+</span>
                <span class="n">AMT_rt2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">line30</span> <span class="o">-</span> <span class="p">(</span><span class="n">AMT_brk1</span> <span class="o">/</span> <span class="n">sep</span><span class="p">))))</span>
    <span class="k">if</span> <span class="n">dwks10</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">dwks13</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">dwks14</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">dwks19</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">e24515</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="c1"># complete Form 6251, Part III (line36 is equal to line30)</span>
        <span class="n">line37</span> <span class="o">=</span> <span class="n">dwks13</span>
        <span class="n">line38</span> <span class="o">=</span> <span class="n">e24515</span>
        <span class="n">line39</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line37</span> <span class="o">+</span> <span class="n">line38</span><span class="p">,</span> <span class="n">dwks10</span><span class="p">)</span>
        <span class="n">line40</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line30</span><span class="p">,</span> <span class="n">line39</span><span class="p">)</span>
        <span class="n">line41</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line30</span> <span class="o">-</span> <span class="n">line40</span><span class="p">)</span>
        <span class="n">line42</span> <span class="o">=</span> <span class="p">(</span><span class="n">AMT_rt1</span> <span class="o">*</span> <span class="n">line41</span> <span class="o">+</span>
                  <span class="n">AMT_rt2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">line41</span> <span class="o">-</span> <span class="p">(</span><span class="n">AMT_brk1</span> <span class="o">/</span> <span class="n">sep</span><span class="p">))))</span>
        <span class="n">line44</span> <span class="o">=</span> <span class="n">dwks14</span>
        <span class="n">line45</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">AMT_CG_brk1</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line44</span><span class="p">)</span>
        <span class="n">line46</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line30</span><span class="p">,</span> <span class="n">line37</span><span class="p">)</span>
        <span class="n">line47</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line45</span><span class="p">,</span> <span class="n">line46</span><span class="p">)</span>  <span class="c1"># line47 is amount taxed at AMT_CG_rt1</span>
        <span class="n">cgtax1</span> <span class="o">=</span> <span class="n">line47</span> <span class="o">*</span> <span class="n">AMT_CG_rt1</span>
        <span class="n">line48</span> <span class="o">=</span> <span class="n">line46</span> <span class="o">-</span> <span class="n">line47</span>
        <span class="n">line51</span> <span class="o">=</span> <span class="n">dwks19</span>
        <span class="n">line52</span> <span class="o">=</span> <span class="n">line45</span> <span class="o">+</span> <span class="n">line51</span>
        <span class="n">line53</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">AMT_CG_brk2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line52</span><span class="p">)</span>
        <span class="n">line54</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line48</span><span class="p">,</span> <span class="n">line53</span><span class="p">)</span>  <span class="c1"># line54 is amount taxed at AMT_CG_rt2</span>
        <span class="n">cgtax2</span> <span class="o">=</span> <span class="n">line54</span> <span class="o">*</span> <span class="n">AMT_CG_rt2</span>
        <span class="n">line56</span> <span class="o">=</span> <span class="n">line47</span> <span class="o">+</span> <span class="n">line54</span>  <span class="c1"># total amount in lower two brackets</span>
        <span class="k">if</span> <span class="n">line41</span> <span class="o">==</span> <span class="n">line56</span><span class="p">:</span>
            <span class="n">line57</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># line57 is amount taxed at AMT_CG_rt3</span>
            <span class="n">linex2</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># linex2 is amount taxed at AMT_CG_rt4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line57</span> <span class="o">=</span> <span class="n">line46</span> <span class="o">-</span> <span class="n">line56</span>
            <span class="n">linex1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line48</span><span class="p">,</span>
                         <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">AMT_CG_brk3</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">line44</span> <span class="o">-</span> <span class="n">line45</span><span class="p">))</span>
            <span class="n">linex2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line54</span> <span class="o">-</span> <span class="n">linex1</span><span class="p">)</span>
        <span class="n">cgtax3</span> <span class="o">=</span> <span class="n">line57</span> <span class="o">*</span> <span class="n">AMT_CG_rt3</span>
        <span class="n">cgtax4</span> <span class="o">=</span> <span class="n">linex2</span> <span class="o">*</span> <span class="n">AMT_CG_rt4</span>
        <span class="k">if</span> <span class="n">line38</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">line61</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line61</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line30</span> <span class="o">-</span> <span class="n">line41</span> <span class="o">-</span> <span class="n">line56</span> <span class="o">-</span> <span class="n">line57</span> <span class="o">-</span> <span class="n">linex2</span><span class="p">)</span>
        <span class="n">line62</span> <span class="o">=</span> <span class="n">line42</span> <span class="o">+</span> <span class="n">cgtax1</span> <span class="o">+</span> <span class="n">cgtax2</span> <span class="o">+</span> <span class="n">cgtax3</span> <span class="o">+</span> <span class="n">cgtax4</span> <span class="o">+</span> <span class="n">line61</span>
        <span class="n">line64</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line3163</span><span class="p">,</span> <span class="n">line62</span><span class="p">)</span>
        <span class="n">line31</span> <span class="o">=</span> <span class="n">line64</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if not completing Form 6251, Part III</span>
        <span class="n">line31</span> <span class="o">=</span> <span class="n">line3163</span>
    <span class="c1"># Form 6251, Part II bottom</span>
    <span class="k">if</span> <span class="n">f6251</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">line32</span> <span class="o">=</span> <span class="n">e62900</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line32</span> <span class="o">=</span> <span class="n">e07300</span>
    <span class="n">line33</span> <span class="o">=</span> <span class="n">line31</span> <span class="o">-</span> <span class="n">line32</span>
    <span class="n">c09600</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line33</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">taxbc</span> <span class="o">-</span> <span class="n">e07300</span> <span class="o">-</span> <span class="n">c05700</span><span class="p">))</span>
    <span class="n">c05800</span> <span class="o">=</span> <span class="n">taxbc</span> <span class="o">+</span> <span class="n">c09600</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c62100</span><span class="p">,</span> <span class="n">c09600</span><span class="p">,</span> <span class="n">c05800</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">NetInvIncTax</span><span class="p">(</span><span class="n">e00300</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span> <span class="n">e02000</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span> <span class="n">c01000</span><span class="p">,</span>
                 <span class="n">c00100</span><span class="p">,</span> <span class="n">NIIT_thd</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">NIIT_PT_taxed</span><span class="p">,</span> <span class="n">NIIT_rt</span><span class="p">,</span> <span class="n">niit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Net Investment Income Tax (NIIT) amount assuming that</span>
<span class="sd">    all annuity income is excluded from net investment income.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">modAGI</span> <span class="o">=</span> <span class="n">c00100</span>  <span class="c1"># no foreign earned income exclusion to add</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">NIIT_PT_taxed</span><span class="p">:</span>
        <span class="n">NII</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00300</span> <span class="o">+</span> <span class="n">e00600</span> <span class="o">+</span> <span class="n">c01000</span> <span class="o">+</span> <span class="n">e02000</span> <span class="o">-</span> <span class="n">e26270</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># do not subtract e26270 from e02000</span>
        <span class="n">NII</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e00300</span> <span class="o">+</span> <span class="n">e00600</span> <span class="o">+</span> <span class="n">c01000</span> <span class="o">+</span> <span class="n">e02000</span><span class="p">)</span>
    <span class="n">niit</span> <span class="o">=</span> <span class="n">NIIT_rt</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">NII</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">modAGI</span> <span class="o">-</span> <span class="n">NIIT_thd</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">niit</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">F2441</span><span class="p">(</span><span class="n">MARS</span><span class="p">,</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">earned_s</span><span class="p">,</span> <span class="n">f2441</span><span class="p">,</span> <span class="n">CDCC_c</span><span class="p">,</span> <span class="n">e32800</span><span class="p">,</span>
          <span class="n">exact</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">CDCC_ps</span><span class="p">,</span> <span class="n">CDCC_crt</span><span class="p">,</span> <span class="n">c05800</span><span class="p">,</span> <span class="n">e07300</span><span class="p">,</span> <span class="n">c07180</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Form 2441 child and dependent care expense credit, c07180.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># credit for at most two cared-for individuals and for actual expenses</span>
    <span class="n">max_credit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">f2441</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">CDCC_c</span>
    <span class="n">c32800</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">e32800</span><span class="p">,</span> <span class="n">max_credit</span><span class="p">))</span>
    <span class="c1"># credit is limited to minimum of individuals&#39; earned income</span>
    <span class="n">c32880</span> <span class="o">=</span> <span class="n">earned_p</span>  <span class="c1"># earned income of taxpayer</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">c32890</span> <span class="o">=</span> <span class="n">earned_s</span>  <span class="c1"># earned income of spouse when present</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c32890</span> <span class="o">=</span> <span class="n">earned_p</span>
    <span class="n">c33000</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">c32800</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">c32880</span><span class="p">,</span> <span class="n">c32890</span><span class="p">)))</span>
    <span class="c1"># credit is limited by AGI-related fraction</span>
    <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
        <span class="n">tratio</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(((</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">CDCC_ps</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2000.</span><span class="p">),</span> <span class="mf">0.</span><span class="p">))</span>
        <span class="n">c33200</span> <span class="o">=</span> <span class="n">c33000</span> <span class="o">*</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">20.</span><span class="p">,</span> <span class="n">CDCC_crt</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mf">15.</span><span class="p">,</span> <span class="n">tratio</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c33200</span> <span class="o">=</span> <span class="n">c33000</span> <span class="o">*</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">20.</span><span class="p">,</span> <span class="n">CDCC_crt</span> <span class="o">-</span>
                                     <span class="nb">max</span><span class="p">(((</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">CDCC_ps</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2000.</span><span class="p">),</span> <span class="mf">0.</span><span class="p">))</span>
    <span class="c1"># credit is limited by tax liability</span>
    <span class="n">c07180</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c05800</span> <span class="o">-</span> <span class="n">e07300</span><span class="p">),</span> <span class="n">c33200</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c07180</span>


<div class="viewcode-block" id="EITCamount"><a class="viewcode-back" href="../../api/calcfunctions.html#taxcalc.calcfunctions.EITCamount">[docs]</a><span class="nd">@JIT</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">EITCamount</span><span class="p">(</span><span class="n">basic_frac</span><span class="p">,</span> <span class="n">phasein_rate</span><span class="p">,</span> <span class="n">earnings</span><span class="p">,</span> <span class="n">max_amount</span><span class="p">,</span>
               <span class="n">phaseout_start</span><span class="p">,</span> <span class="n">agi</span><span class="p">,</span> <span class="n">phaseout_rate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns EITC amount given specified parameters.</span>
<span class="sd">    English parameter names are used in this function because the</span>
<span class="sd">    EITC formula is not available on IRS forms or in IRS instructions;</span>
<span class="sd">    the extensive IRS EITC look-up table does not reveal the formula.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eitc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">basic_frac</span> <span class="o">*</span> <span class="n">max_amount</span> <span class="o">+</span>
                <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">basic_frac</span><span class="p">)</span> <span class="o">*</span> <span class="n">phasein_rate</span> <span class="o">*</span> <span class="n">earnings</span><span class="p">),</span> <span class="n">max_amount</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">earnings</span> <span class="o">&gt;</span> <span class="n">phaseout_start</span> <span class="ow">or</span> <span class="n">agi</span> <span class="o">&gt;</span> <span class="n">phaseout_start</span><span class="p">:</span>
        <span class="n">eitcx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">max_amount</span> <span class="o">-</span> <span class="n">phaseout_rate</span> <span class="o">*</span>
                         <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">earnings</span><span class="p">,</span> <span class="n">agi</span><span class="p">)</span> <span class="o">-</span> <span class="n">phaseout_start</span><span class="p">)))</span>
        <span class="n">eitc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">eitc</span><span class="p">,</span> <span class="n">eitcx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">eitc</span></div>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">EITC</span><span class="p">(</span><span class="n">MARS</span><span class="p">,</span> <span class="n">DSI</span><span class="p">,</span> <span class="n">EIC</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">e00300</span><span class="p">,</span> <span class="n">e00400</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span> <span class="n">c01000</span><span class="p">,</span>
         <span class="n">e02000</span><span class="p">,</span> <span class="n">e26270</span><span class="p">,</span> <span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">earned_s</span><span class="p">,</span>
         <span class="n">EITC_ps</span><span class="p">,</span> <span class="n">EITC_MinEligAge</span><span class="p">,</span> <span class="n">EITC_MaxEligAge</span><span class="p">,</span> <span class="n">EITC_ps_MarriedJ</span><span class="p">,</span>
         <span class="n">EITC_rt</span><span class="p">,</span> <span class="n">EITC_c</span><span class="p">,</span> <span class="n">EITC_prt</span><span class="p">,</span> <span class="n">EITC_basic_frac</span><span class="p">,</span>
         <span class="n">EITC_InvestIncome_c</span><span class="p">,</span> <span class="n">EITC_excess_InvestIncome_rt</span><span class="p">,</span>
         <span class="n">EITC_indiv</span><span class="p">,</span> <span class="n">EITC_sep_filers_elig</span><span class="p">,</span>
         <span class="n">c59660</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes EITC amount, c59660.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=too-many-branches</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">eitc</span> <span class="o">=</span> <span class="n">EITCamount</span><span class="p">(</span><span class="n">EITC_basic_frac</span><span class="p">,</span>
                          <span class="n">EITC_rt</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span> <span class="n">earned</span><span class="p">,</span> <span class="n">EITC_c</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span>
                          <span class="n">EITC_ps</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">EITC_prt</span><span class="p">[</span><span class="n">EIC</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">EIC</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># enforce age eligibility rule for those with no EITC-eligible</span>
            <span class="c1"># kids assuming that an unknown age_* value implies EITC age</span>
            <span class="c1"># eligibility</span>
            <span class="n">h_age_elig</span> <span class="o">=</span> <span class="n">EITC_MinEligAge</span> <span class="o">&lt;=</span> <span class="n">age_head</span> <span class="o">&lt;=</span> <span class="n">EITC_MaxEligAge</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">age_head</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h_age_elig</span><span class="p">):</span>
                <span class="n">c59660</span> <span class="o">=</span> <span class="n">eitc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c59660</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if EIC != 0</span>
            <span class="n">c59660</span> <span class="o">=</span> <span class="n">eitc</span>

    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">po_start</span> <span class="o">=</span> <span class="n">EITC_ps</span><span class="p">[</span><span class="n">EIC</span><span class="p">]</span> <span class="o">+</span> <span class="n">EITC_ps_MarriedJ</span><span class="p">[</span><span class="n">EIC</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">EITC_indiv</span><span class="p">:</span>
            <span class="c1"># filing unit EITC rather than individual EITC</span>
            <span class="n">eitc</span> <span class="o">=</span> <span class="n">EITCamount</span><span class="p">(</span><span class="n">EITC_basic_frac</span><span class="p">,</span>
                              <span class="n">EITC_rt</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span> <span class="n">earned</span><span class="p">,</span> <span class="n">EITC_c</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span>
                              <span class="n">po_start</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">EITC_prt</span><span class="p">[</span><span class="n">EIC</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">EITC_indiv</span><span class="p">:</span>
            <span class="c1"># individual EITC rather than a filing-unit EITC</span>
            <span class="n">eitc_p</span> <span class="o">=</span> <span class="n">EITCamount</span><span class="p">(</span><span class="n">EITC_basic_frac</span><span class="p">,</span>
                                <span class="n">EITC_rt</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">EITC_c</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span>
                                <span class="n">po_start</span><span class="p">,</span> <span class="n">earned_p</span><span class="p">,</span> <span class="n">EITC_prt</span><span class="p">[</span><span class="n">EIC</span><span class="p">])</span>
            <span class="n">eitc_s</span> <span class="o">=</span> <span class="n">EITCamount</span><span class="p">(</span><span class="n">EITC_basic_frac</span><span class="p">,</span>
                                <span class="n">EITC_rt</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span> <span class="n">earned_s</span><span class="p">,</span> <span class="n">EITC_c</span><span class="p">[</span><span class="n">EIC</span><span class="p">],</span>
                                <span class="n">po_start</span><span class="p">,</span> <span class="n">earned_s</span><span class="p">,</span> <span class="n">EITC_prt</span><span class="p">[</span><span class="n">EIC</span><span class="p">])</span>
            <span class="n">eitc</span> <span class="o">=</span> <span class="n">eitc_p</span> <span class="o">+</span> <span class="n">eitc_s</span>

        <span class="k">if</span> <span class="n">EIC</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">h_age_elig</span> <span class="o">=</span> <span class="n">EITC_MinEligAge</span> <span class="o">&lt;=</span> <span class="n">age_head</span> <span class="o">&lt;=</span> <span class="n">EITC_MaxEligAge</span>
            <span class="n">s_age_elig</span> <span class="o">=</span> <span class="n">EITC_MinEligAge</span> <span class="o">&lt;=</span> <span class="n">age_spouse</span> <span class="o">&lt;=</span> <span class="n">EITC_MaxEligAge</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">age_head</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">age_spouse</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">h_age_elig</span> <span class="ow">or</span> <span class="n">s_age_elig</span><span class="p">):</span>
                <span class="n">c59660</span> <span class="o">=</span> <span class="n">eitc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c59660</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c59660</span> <span class="o">=</span> <span class="n">eitc</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">MARS</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">EITC_sep_filers_elig</span><span class="p">)</span> <span class="ow">or</span> <span class="n">DSI</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">c59660</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># reduce positive EITC if investment income exceeds ceiling</span>
    <span class="k">if</span> <span class="n">c59660</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">invinc</span> <span class="o">=</span> <span class="p">(</span><span class="n">e00400</span> <span class="o">+</span> <span class="n">e00300</span> <span class="o">+</span> <span class="n">e00600</span> <span class="o">+</span>
                  <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c01000</span><span class="p">)</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">e02000</span> <span class="o">-</span> <span class="n">e26270</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">invinc</span> <span class="o">&gt;</span> <span class="n">EITC_InvestIncome_c</span><span class="p">:</span>
            <span class="n">eitc</span> <span class="o">=</span> <span class="p">(</span><span class="n">c59660</span> <span class="o">-</span> <span class="n">EITC_excess_InvestIncome_rt</span> <span class="o">*</span>
                    <span class="p">(</span><span class="n">invinc</span> <span class="o">-</span> <span class="n">EITC_InvestIncome_c</span><span class="p">))</span>
            <span class="n">c59660</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">eitc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c59660</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">RefundablePayrollTaxCredit</span><span class="p">(</span><span class="n">was_plus_sey_p</span><span class="p">,</span> <span class="n">was_plus_sey_s</span><span class="p">,</span>
                               <span class="n">RPTC_c</span><span class="p">,</span> <span class="n">RPTC_rt</span><span class="p">,</span>
                               <span class="n">rptc_p</span><span class="p">,</span> <span class="n">rptc_s</span><span class="p">,</span> <span class="n">rptc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes refundable payroll tax credit amounts.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rptc_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">was_plus_sey_p</span> <span class="o">*</span> <span class="n">RPTC_rt</span><span class="p">,</span> <span class="n">RPTC_c</span><span class="p">)</span>
    <span class="n">rptc_s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">was_plus_sey_s</span> <span class="o">*</span> <span class="n">RPTC_rt</span><span class="p">,</span> <span class="n">RPTC_c</span><span class="p">)</span>
    <span class="n">rptc</span> <span class="o">=</span> <span class="n">rptc_p</span> <span class="o">+</span> <span class="n">rptc_s</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rptc_p</span><span class="p">,</span> <span class="n">rptc_s</span><span class="p">,</span> <span class="n">rptc</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ChildDepTaxCredit</span><span class="p">(</span><span class="n">n24</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">XTOT</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">c05800</span><span class="p">,</span>
                      <span class="n">e07260</span><span class="p">,</span> <span class="n">CR_ResidentialEnergy_hc</span><span class="p">,</span>
                      <span class="n">e07300</span><span class="p">,</span> <span class="n">CR_ForeignTax_hc</span><span class="p">,</span>
                      <span class="n">c07180</span><span class="p">,</span>
                      <span class="n">c07230</span><span class="p">,</span>
                      <span class="n">e07240</span><span class="p">,</span> <span class="n">CR_RetirementSavings_hc</span><span class="p">,</span>
                      <span class="n">c07200</span><span class="p">,</span>
                      <span class="n">CTC_c</span><span class="p">,</span> <span class="n">CTC_ps</span><span class="p">,</span> <span class="n">CTC_prt</span><span class="p">,</span> <span class="n">exact</span><span class="p">,</span> <span class="n">ODC_c</span><span class="p">,</span>
                      <span class="n">CTC_c_under6_bonus</span><span class="p">,</span> <span class="n">nu06</span><span class="p">,</span>
                      <span class="n">c07220</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span> <span class="n">codtc_limited</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes amounts on &quot;Child Tax Credit and Credit for Other Dependents</span>
<span class="sd">    Worksheet&quot; in 2018 Publication 972, which pertain to these two</span>
<span class="sd">    nonrefundable tax credits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Worksheet Part 1</span>
    <span class="n">line1</span> <span class="o">=</span> <span class="n">CTC_c</span> <span class="o">*</span> <span class="n">n24</span> <span class="o">+</span> <span class="n">CTC_c_under6_bonus</span> <span class="o">*</span> <span class="n">nu06</span>
    <span class="n">line2</span> <span class="o">=</span> <span class="n">ODC_c</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">XTOT</span> <span class="o">-</span> <span class="n">n24</span> <span class="o">-</span> <span class="n">num</span><span class="p">)</span>
    <span class="n">line3</span> <span class="o">=</span> <span class="n">line1</span> <span class="o">+</span> <span class="n">line2</span>
    <span class="n">modAGI</span> <span class="o">=</span> <span class="n">c00100</span>  <span class="c1"># no foreign earned income exclusion to add to AGI (line6)</span>
    <span class="k">if</span> <span class="n">line3</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">modAGI</span> <span class="o">&gt;</span> <span class="n">CTC_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">excess</span> <span class="o">=</span> <span class="n">modAGI</span> <span class="o">-</span> <span class="n">CTC_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
            <span class="n">excess</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">excess</span> <span class="o">/</span> <span class="mf">1000.</span><span class="p">)</span>
        <span class="n">line10</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line3</span> <span class="o">-</span> <span class="n">CTC_prt</span> <span class="o">*</span> <span class="n">excess</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line10</span> <span class="o">=</span> <span class="n">line3</span>
    <span class="k">if</span> <span class="n">line10</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="c1"># Worksheet Part 2</span>
        <span class="n">line11</span> <span class="o">=</span> <span class="n">c05800</span>
        <span class="n">line12</span> <span class="o">=</span> <span class="p">(</span><span class="n">e07260</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_ResidentialEnergy_hc</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">e07300</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_ForeignTax_hc</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">c07180</span> <span class="o">+</span>  <span class="c1"># child &amp; dependent care expense credit</span>
                  <span class="n">c07230</span> <span class="o">+</span>  <span class="c1"># education credit</span>
                  <span class="n">e07240</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_RetirementSavings_hc</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">c07200</span><span class="p">)</span>  <span class="c1"># Schedule R credit</span>
        <span class="n">line13</span> <span class="o">=</span> <span class="n">line11</span> <span class="o">-</span> <span class="n">line12</span>
        <span class="n">line14</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">line15</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line13</span> <span class="o">-</span> <span class="n">line14</span><span class="p">)</span>
        <span class="n">line16</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line10</span><span class="p">,</span> <span class="n">line15</span><span class="p">)</span>  <span class="c1"># credit is capped by tax liability</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line16</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1"># separate the CTC and ODTC amounts</span>
    <span class="n">c07220</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># nonrefundable CTC amount</span>
    <span class="n">odc</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># nonrefundable ODTC amount</span>
    <span class="k">if</span> <span class="n">line16</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line1</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">c07220</span> <span class="o">=</span> <span class="n">line16</span> <span class="o">*</span> <span class="n">line1</span> <span class="o">/</span> <span class="n">line3</span>
        <span class="n">odc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line16</span> <span class="o">-</span> <span class="n">c07220</span><span class="p">)</span>
    <span class="c1"># compute codtc_limited for use in AdditionalCTC function</span>
    <span class="n">codtc_limited</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line10</span> <span class="o">-</span> <span class="n">line16</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c07220</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span> <span class="n">codtc_limited</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">PersonalTaxCredit</span><span class="p">(</span><span class="n">MARS</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span>
                      <span class="n">II_credit</span><span class="p">,</span> <span class="n">II_credit_ps</span><span class="p">,</span> <span class="n">II_credit_prt</span><span class="p">,</span>
                      <span class="n">II_credit_nr</span><span class="p">,</span> <span class="n">II_credit_nr_ps</span><span class="p">,</span> <span class="n">II_credit_nr_prt</span><span class="p">,</span>
                      <span class="n">personal_refundable_credit</span><span class="p">,</span>
                      <span class="n">personal_nonrefundable_credit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes personal_refundable_credit and personal_nonrefundable_credit,</span>
<span class="sd">    neither of which are part of current-law policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># calculate personal refundable credit amount with phase-out</span>
    <span class="n">personal_refundable_credit</span> <span class="o">=</span> <span class="n">II_credit</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">II_credit_prt</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="n">II_credit_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">pout</span> <span class="o">=</span> <span class="n">II_credit_prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">II_credit_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">fully_phasedout</span> <span class="o">=</span> <span class="n">personal_refundable_credit</span> <span class="o">-</span> <span class="n">pout</span>
        <span class="n">personal_refundable_credit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fully_phasedout</span><span class="p">)</span>
    <span class="c1"># calculate personal nonrefundable credit amount with phase-out</span>
    <span class="n">personal_nonrefundable_credit</span> <span class="o">=</span> <span class="n">II_credit_nr</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">II_credit_nr_prt</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&gt;</span> <span class="n">II_credit_nr_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">pout</span> <span class="o">=</span> <span class="n">II_credit_nr_prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">II_credit_nr_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">fully_phasedout</span> <span class="o">=</span> <span class="n">personal_nonrefundable_credit</span> <span class="o">-</span> <span class="n">pout</span>
        <span class="n">personal_nonrefundable_credit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fully_phasedout</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">personal_refundable_credit</span><span class="p">,</span> <span class="n">personal_nonrefundable_credit</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">AmOppCreditParts</span><span class="p">(</span><span class="n">exact</span><span class="p">,</span> <span class="n">e87521</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">CR_AmOppRefundable_hc</span><span class="p">,</span>
                     <span class="n">CR_AmOppNonRefundable_hc</span><span class="p">,</span> <span class="n">c10960</span><span class="p">,</span> <span class="n">c87668</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies a phaseout to the Form 8863, line 1, American Opportunity Credit</span>
<span class="sd">    amount, e87521, and then applies the 0.4 refundable rate.</span>
<span class="sd">    Logic corresponds to Form 8863, Part I.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Tax Law Parameters that are not parameterized:</span>

<span class="sd">        90000 : American Opportunity Credit phaseout income base</span>

<span class="sd">        10000 : American Opportunity Credit phaseout income range length</span>

<span class="sd">        1/1000 : American Opportunity Credit phaseout rate</span>

<span class="sd">        0.4 : American Opportunity Credit refundable rate</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        exact : whether or not to do rounding of phaseout fraction</span>

<span class="sd">        e87521 : total tentative American Opportunity Credit for all students,</span>
<span class="sd">                 Form 8863, line 1</span>

<span class="sd">        num : number of people filing jointly</span>

<span class="sd">        c00100 : AGI</span>

<span class="sd">        CR_AmOppRefundable_hc: haircut for the refundable portion of the</span>
<span class="sd">                               American Opportunity Credit</span>

<span class="sd">        CR_AmOppNonRefundable_hc: haircut for the nonrefundable portion of the</span>
<span class="sd">                                  American Opportunity Credit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        c10960 : Refundable part of American Opportunity Credit</span>

<span class="sd">        c87668 : Tentative nonrefundable part of American Opportunity Credit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">e87521</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">c87658</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">90000.</span> <span class="o">*</span> <span class="n">num</span> <span class="o">-</span> <span class="n">c00100</span><span class="p">)</span>
        <span class="n">c87660</span> <span class="o">=</span> <span class="mf">10000.</span> <span class="o">*</span> <span class="n">num</span>
        <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
            <span class="n">c87662</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">c87658</span> <span class="o">/</span> <span class="n">c87660</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c87662</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">c87658</span> <span class="o">/</span> <span class="n">c87660</span><span class="p">)</span>
        <span class="n">c87664</span> <span class="o">=</span> <span class="n">c87662</span> <span class="o">*</span> <span class="n">e87521</span> <span class="o">/</span> <span class="mf">1000.</span>
        <span class="n">c10960</span> <span class="o">=</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">c87664</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_AmOppRefundable_hc</span><span class="p">)</span>
        <span class="n">c87668</span> <span class="o">=</span> <span class="n">c87664</span> <span class="o">-</span> <span class="n">c10960</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_AmOppNonRefundable_hc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c10960</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">c87668</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c10960</span><span class="p">,</span> <span class="n">c87668</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">SchR</span><span class="p">(</span><span class="n">age_head</span><span class="p">,</span> <span class="n">age_spouse</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span>
         <span class="n">c05800</span><span class="p">,</span> <span class="n">e07300</span><span class="p">,</span> <span class="n">c07180</span><span class="p">,</span> <span class="n">e02400</span><span class="p">,</span> <span class="n">c02500</span><span class="p">,</span> <span class="n">e01500</span><span class="p">,</span> <span class="n">e01700</span><span class="p">,</span> <span class="n">CR_SchR_hc</span><span class="p">,</span>
         <span class="n">c07200</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Schedule R credit for the elderly and the disabled, c07200.</span>

<span class="sd">    Note that no Schedule R policy parameters are inflation indexed.</span>

<span class="sd">    Note that all Schedule R policy parameters are hard-coded, and therefore,</span>
<span class="sd">    are not able to be changed using Policy class parameters.</span>

<span class="sd">    Note that the CR_SchR_hc policy parameter allows the user to eliminate</span>
<span class="sd">    or reduce total Schedule R credits.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">age_head</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="ow">or</span> <span class="p">(</span><span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">):</span>
        <span class="c1"># calculate credit assuming nobody is disabled (so line12 = line10)</span>
        <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">age_head</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="ow">and</span> <span class="n">age_spouse</span> <span class="o">&gt;=</span> <span class="mi">65</span><span class="p">:</span>
                <span class="n">schr12</span> <span class="o">=</span> <span class="mf">7500.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">schr12</span> <span class="o">=</span> <span class="mf">5000.</span>
            <span class="n">schr15</span> <span class="o">=</span> <span class="mf">10000.</span>
        <span class="k">elif</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">schr12</span> <span class="o">=</span> <span class="mf">3750.</span>
            <span class="n">schr15</span> <span class="o">=</span> <span class="mf">5000.</span>
        <span class="k">elif</span> <span class="n">MARS</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">schr12</span> <span class="o">=</span> <span class="mf">5000.</span>
            <span class="n">schr15</span> <span class="o">=</span> <span class="mf">7500.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">schr12</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">schr15</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="c1"># nontaxable portion of OASDI benefits, line 13a</span>
        <span class="n">schr13a</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e02400</span> <span class="o">-</span> <span class="n">c02500</span><span class="p">)</span>
        <span class="c1"># nontaxable portion of pension benefits, line 13b</span>
        <span class="c1"># NOTE: the following approximation (required because of inadequate IRS</span>
        <span class="c1">#       data) will be accurate if all pensions are partially taxable</span>
        <span class="c1">#       or if all pensions are fully taxable.  But if a filing unit</span>
        <span class="c1">#       receives at least one partially taxable pension and at least</span>
        <span class="c1">#       one fully taxable pension, then the approximation in the</span>
        <span class="c1">#       following line is not exactly correct.</span>
        <span class="n">schr13b</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">e01500</span> <span class="o">-</span> <span class="n">e01700</span><span class="p">)</span>
        <span class="n">schr13c</span> <span class="o">=</span> <span class="n">schr13a</span> <span class="o">+</span> <span class="n">schr13b</span>
        <span class="n">schr16</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c00100</span> <span class="o">-</span> <span class="n">schr15</span><span class="p">)</span>
        <span class="n">schr17</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">schr16</span>
        <span class="n">schr18</span> <span class="o">=</span> <span class="n">schr13c</span> <span class="o">+</span> <span class="n">schr17</span>
        <span class="n">schr19</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">schr12</span> <span class="o">-</span> <span class="n">schr18</span><span class="p">)</span>
        <span class="n">schr20</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">schr19</span>
        <span class="n">schr21</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">c05800</span> <span class="o">-</span> <span class="n">e07300</span> <span class="o">-</span> <span class="n">c07180</span><span class="p">))</span>
        <span class="n">c07200</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">schr20</span><span class="p">,</span> <span class="n">schr21</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_SchR_hc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># if not calculating Schedule R credit</span>
        <span class="n">c07200</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">c07200</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">EducationTaxCredit</span><span class="p">(</span><span class="n">exact</span><span class="p">,</span> <span class="n">e87530</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">c05800</span><span class="p">,</span>
                       <span class="n">e07300</span><span class="p">,</span> <span class="n">c07180</span><span class="p">,</span> <span class="n">c07200</span><span class="p">,</span> <span class="n">c87668</span><span class="p">,</span>
                       <span class="n">LLC_Expense_c</span><span class="p">,</span> <span class="n">ETC_pe_Single</span><span class="p">,</span> <span class="n">ETC_pe_Married</span><span class="p">,</span>
                       <span class="n">CR_Education_hc</span><span class="p">,</span>
                       <span class="n">c07230</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Education Tax Credits (Form 8863) nonrefundable amount, c07230.</span>
<span class="sd">    Logic corresponds to Form 8863, Part II.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Tax Law Parameters that are not parameterized:</span>

<span class="sd">        0.2 : Lifetime Learning Credit ratio against expense</span>

<span class="sd">    Tax Law Parameters that are parameterized:</span>

<span class="sd">        LLC_Expense_c : Lifetime Learning Credit expense limit</span>

<span class="sd">        ETC_pe_Married : Education Tax Credit phaseout end for married</span>

<span class="sd">        ETC_pe_Single : Education Tax Credit phaseout end for single</span>

<span class="sd">    Taxpayer Charateristics:</span>

<span class="sd">        exact : whether or not to do rounding of phaseout fraction</span>

<span class="sd">        e87530 : Lifetime Learning Credit total qualified expenses,</span>
<span class="sd">                 Form 8863, line 10</span>

<span class="sd">        e07300 : Foreign tax credit - Form 1116</span>

<span class="sd">        c07180 : Child/dependent care expense credit - Form 2441</span>

<span class="sd">        c07200 : Schedule R credit</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    c07230 : Education Tax Credits (Form 8863) nonrefundable amount</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c87560</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">e87530</span><span class="p">,</span> <span class="n">LLC_Expense_c</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">MARS</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">c87570</span> <span class="o">=</span> <span class="n">ETC_pe_Married</span> <span class="o">*</span> <span class="mf">1000.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c87570</span> <span class="o">=</span> <span class="n">ETC_pe_Single</span> <span class="o">*</span> <span class="mf">1000.</span>
    <span class="n">c87590</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c87570</span> <span class="o">-</span> <span class="n">c00100</span><span class="p">)</span>
    <span class="n">c87600</span> <span class="o">=</span> <span class="mf">10000.</span> <span class="o">*</span> <span class="n">num</span>
    <span class="k">if</span> <span class="n">exact</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># exact calculation as on tax forms</span>
        <span class="n">c87610</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">c87590</span> <span class="o">/</span> <span class="n">c87600</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c87610</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">c87590</span> <span class="o">/</span> <span class="n">c87600</span><span class="p">)</span>
    <span class="n">c87620</span> <span class="o">=</span> <span class="n">c87560</span> <span class="o">*</span> <span class="n">c87610</span>
    <span class="n">xline4</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c05800</span> <span class="o">-</span> <span class="p">(</span><span class="n">e07300</span> <span class="o">+</span> <span class="n">c07180</span> <span class="o">+</span> <span class="n">c07200</span><span class="p">))</span>
    <span class="n">xline5</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c87620</span><span class="p">,</span> <span class="n">xline4</span><span class="p">)</span>
    <span class="n">xline9</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c05800</span> <span class="o">-</span> <span class="p">(</span><span class="n">e07300</span> <span class="o">+</span> <span class="n">c07180</span> <span class="o">+</span> <span class="n">c07200</span> <span class="o">+</span> <span class="n">xline5</span><span class="p">))</span>
    <span class="n">xline10</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c87668</span><span class="p">,</span> <span class="n">xline9</span><span class="p">)</span>
    <span class="n">c87680</span> <span class="o">=</span> <span class="n">xline5</span> <span class="o">+</span> <span class="n">xline10</span>
    <span class="n">c07230</span> <span class="o">=</span> <span class="n">c87680</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_Education_hc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c07230</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">CharityCredit</span><span class="p">(</span><span class="n">e19800</span><span class="p">,</span> <span class="n">e20100</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">CR_Charity_rt</span><span class="p">,</span> <span class="n">CR_Charity_f</span><span class="p">,</span>
                  <span class="n">CR_Charity_frt</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">charity_credit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes nonrefundable charity credit, charity_credit.</span>
<span class="sd">    This credit is not part of current-law policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_charity</span> <span class="o">=</span> <span class="n">e19800</span> <span class="o">+</span> <span class="n">e20100</span>
    <span class="n">floor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">CR_Charity_frt</span> <span class="o">*</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">CR_Charity_f</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">charity_cr_floored</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">total_charity</span> <span class="o">-</span> <span class="n">floor</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">charity_credit</span> <span class="o">=</span> <span class="n">CR_Charity_rt</span> <span class="o">*</span> <span class="p">(</span><span class="n">charity_cr_floored</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">charity_credit</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">NonrefundableCredits</span><span class="p">(</span><span class="n">c05800</span><span class="p">,</span> <span class="n">e07240</span><span class="p">,</span> <span class="n">e07260</span><span class="p">,</span> <span class="n">e07300</span><span class="p">,</span> <span class="n">e07400</span><span class="p">,</span>
                         <span class="n">e07600</span><span class="p">,</span> <span class="n">p08000</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span>
                         <span class="n">personal_nonrefundable_credit</span><span class="p">,</span>
                         <span class="n">CR_RetirementSavings_hc</span><span class="p">,</span> <span class="n">CR_ForeignTax_hc</span><span class="p">,</span>
                         <span class="n">CR_ResidentialEnergy_hc</span><span class="p">,</span> <span class="n">CR_GeneralBusiness_hc</span><span class="p">,</span>
                         <span class="n">CR_MinimumTax_hc</span><span class="p">,</span> <span class="n">CR_OtherCredits_hc</span><span class="p">,</span> <span class="n">charity_credit</span><span class="p">,</span>
                         <span class="n">c07180</span><span class="p">,</span> <span class="n">c07200</span><span class="p">,</span> <span class="n">c07220</span><span class="p">,</span> <span class="n">c07230</span><span class="p">,</span> <span class="n">c07240</span><span class="p">,</span>
                         <span class="n">c07260</span><span class="p">,</span> <span class="n">c07300</span><span class="p">,</span> <span class="n">c07400</span><span class="p">,</span> <span class="n">c07600</span><span class="p">,</span> <span class="n">c08000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NonRefundableCredits function sequentially limits credits to tax liability.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    CR_RetirementSavings_hc: Retirement savings credit haircut</span>
<span class="sd">    CR_ForeignTax_hc: Foreign tax credit haircut</span>
<span class="sd">    CR_ResidentialEnergy_hc: Residential energy credit haircut</span>
<span class="sd">    CR_GeneralBusiness_hc: General business credit haircut</span>
<span class="sd">    CR_MinimumTax_hc: Minimum tax credit haircut</span>
<span class="sd">    CR_OtherCredits_hc: Other credits haircut</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># limit tax credits to tax liability in order they are on 2015 1040 form</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">c05800</span>
    <span class="c1"># Foreign tax credit - Form 1116</span>
    <span class="n">c07300</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e07300</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_ForeignTax_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07300</span>
    <span class="c1"># Child &amp; dependent care expense credit</span>
    <span class="n">c07180</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c07180</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07180</span>
    <span class="c1"># Education tax credit</span>
    <span class="n">c07230</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c07230</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07230</span>
    <span class="c1"># Retirement savings credit - Form 8880</span>
    <span class="n">c07240</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e07240</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_RetirementSavings_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07240</span>
    <span class="c1"># Child tax credit</span>
    <span class="n">c07220</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c07220</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07220</span>
    <span class="c1"># Other dependent credit</span>
    <span class="n">odc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">odc</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">odc</span>
    <span class="c1"># Residential energy credit - Form 5695</span>
    <span class="n">c07260</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e07260</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_ResidentialEnergy_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07260</span>
    <span class="c1"># General business credit - Form 3800</span>
    <span class="n">c07400</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e07400</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_GeneralBusiness_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07400</span>
    <span class="c1"># Prior year minimum tax credit - Form 8801</span>
    <span class="n">c07600</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">e07600</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_MinimumTax_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07600</span>
    <span class="c1"># Schedule R credit</span>
    <span class="n">c07200</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c07200</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c07200</span>
    <span class="c1"># Other credits</span>
    <span class="n">c08000</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p08000</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">CR_OtherCredits_hc</span><span class="p">),</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">c08000</span>
    <span class="n">charity_credit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">charity_credit</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">charity_credit</span>
    <span class="c1"># Personal nonrefundable credit</span>
    <span class="n">personal_nonrefundable_credit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">personal_nonrefundable_credit</span><span class="p">,</span> <span class="n">avail</span><span class="p">)</span>
    <span class="n">avail</span> <span class="o">=</span> <span class="n">avail</span> <span class="o">-</span> <span class="n">personal_nonrefundable_credit</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c07180</span><span class="p">,</span> <span class="n">c07200</span><span class="p">,</span> <span class="n">c07220</span><span class="p">,</span> <span class="n">c07230</span><span class="p">,</span> <span class="n">c07240</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span>
            <span class="n">c07260</span><span class="p">,</span> <span class="n">c07300</span><span class="p">,</span> <span class="n">c07400</span><span class="p">,</span> <span class="n">c07600</span><span class="p">,</span> <span class="n">c08000</span><span class="p">,</span> <span class="n">charity_credit</span><span class="p">,</span>
            <span class="n">personal_nonrefundable_credit</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">AdditionalCTC</span><span class="p">(</span><span class="n">codtc_limited</span><span class="p">,</span> <span class="n">ACTC_c</span><span class="p">,</span> <span class="n">n24</span><span class="p">,</span> <span class="n">earned</span><span class="p">,</span> <span class="n">ACTC_Income_thd</span><span class="p">,</span>
                  <span class="n">ACTC_rt</span><span class="p">,</span> <span class="n">nu06</span><span class="p">,</span> <span class="n">ACTC_rt_bonus_under6family</span><span class="p">,</span> <span class="n">ACTC_ChildNum</span><span class="p">,</span>
                  <span class="n">ptax_was</span><span class="p">,</span> <span class="n">c03260</span><span class="p">,</span> <span class="n">e09800</span><span class="p">,</span> <span class="n">c59660</span><span class="p">,</span> <span class="n">e11200</span><span class="p">,</span>
                  <span class="n">c11070</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates refundable Additional Child Tax Credit (ACTC), c11070,</span>
<span class="sd">    following 2018 Form 8812 logic.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Part I</span>
    <span class="n">line3</span> <span class="o">=</span> <span class="n">codtc_limited</span>
    <span class="n">line4</span> <span class="o">=</span> <span class="n">ACTC_c</span> <span class="o">*</span> <span class="n">n24</span>
    <span class="n">c11070</span> <span class="o">=</span> <span class="mf">0.</span>  <span class="c1"># line15</span>
    <span class="k">if</span> <span class="n">line3</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">line4</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">line5</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line3</span><span class="p">,</span> <span class="n">line4</span><span class="p">)</span>
        <span class="n">line7</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">earned</span> <span class="o">-</span> <span class="n">ACTC_Income_thd</span><span class="p">)</span>
        <span class="c1"># accommodate ACTC rate bonus for families with children under 5</span>
        <span class="k">if</span> <span class="n">nu06</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ACTC_rate</span> <span class="o">=</span> <span class="n">ACTC_rt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ACTC_rate</span> <span class="o">=</span> <span class="n">ACTC_rt</span> <span class="o">+</span> <span class="n">ACTC_rt_bonus_under6family</span>
        <span class="n">line8</span> <span class="o">=</span> <span class="n">ACTC_rate</span> <span class="o">*</span> <span class="n">line7</span>
        <span class="k">if</span> <span class="n">n24</span> <span class="o">&lt;</span> <span class="n">ACTC_ChildNum</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line8</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">c11070</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line5</span><span class="p">,</span> <span class="n">line8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># if n24 &gt;= ACTC_ChildNum</span>
            <span class="k">if</span> <span class="n">line8</span> <span class="o">&gt;=</span> <span class="n">line5</span><span class="p">:</span>
                <span class="n">c11070</span> <span class="o">=</span> <span class="n">line5</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># complete Part II</span>
                <span class="n">line9</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ptax_was</span>
                <span class="n">line10</span> <span class="o">=</span> <span class="n">c03260</span> <span class="o">+</span> <span class="n">e09800</span>
                <span class="n">line11</span> <span class="o">=</span> <span class="n">line9</span> <span class="o">+</span> <span class="n">line10</span>
                <span class="n">line12</span> <span class="o">=</span> <span class="n">c59660</span> <span class="o">+</span> <span class="n">e11200</span>
                <span class="n">line13</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">line11</span> <span class="o">-</span> <span class="n">line12</span><span class="p">)</span>
                <span class="n">line14</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">line8</span><span class="p">,</span> <span class="n">line13</span><span class="p">)</span>
                <span class="n">c11070</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line5</span><span class="p">,</span> <span class="n">line14</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">c11070</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">C1040</span><span class="p">(</span><span class="n">c05800</span><span class="p">,</span> <span class="n">c07180</span><span class="p">,</span> <span class="n">c07200</span><span class="p">,</span> <span class="n">c07220</span><span class="p">,</span> <span class="n">c07230</span><span class="p">,</span> <span class="n">c07240</span><span class="p">,</span> <span class="n">c07260</span><span class="p">,</span> <span class="n">c07300</span><span class="p">,</span>
          <span class="n">c07400</span><span class="p">,</span> <span class="n">c07600</span><span class="p">,</span> <span class="n">c08000</span><span class="p">,</span> <span class="n">e09700</span><span class="p">,</span> <span class="n">e09800</span><span class="p">,</span> <span class="n">e09900</span><span class="p">,</span> <span class="n">niit</span><span class="p">,</span> <span class="n">othertaxes</span><span class="p">,</span>
          <span class="n">c07100</span><span class="p">,</span> <span class="n">c09200</span><span class="p">,</span> <span class="n">odc</span><span class="p">,</span> <span class="n">charity_credit</span><span class="p">,</span>
          <span class="n">personal_nonrefundable_credit</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes total used nonrefundable credits, c07100, othertaxes, and</span>
<span class="sd">    income tax before refundable credits, c09200.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># total used nonrefundable credits (as computed in NonrefundableCredits)</span>
    <span class="n">c07100</span> <span class="o">=</span> <span class="p">(</span><span class="n">c07180</span> <span class="o">+</span> <span class="n">c07200</span> <span class="o">+</span> <span class="n">c07600</span> <span class="o">+</span> <span class="n">c07300</span> <span class="o">+</span> <span class="n">c07400</span> <span class="o">+</span> <span class="n">c07220</span> <span class="o">+</span> <span class="n">c08000</span> <span class="o">+</span>
              <span class="n">c07230</span> <span class="o">+</span> <span class="n">c07240</span> <span class="o">+</span> <span class="n">c07260</span> <span class="o">+</span> <span class="n">odc</span> <span class="o">+</span> <span class="n">charity_credit</span> <span class="o">+</span>
              <span class="n">personal_nonrefundable_credit</span><span class="p">)</span>
    <span class="c1"># tax after credits (2016 Form 1040, line 56)</span>
    <span class="n">tax_net_nonrefundable_credits</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">c05800</span> <span class="o">-</span> <span class="n">c07100</span><span class="p">)</span>
    <span class="c1"># tax (including othertaxes) before refundable credits</span>
    <span class="n">othertaxes</span> <span class="o">=</span> <span class="n">e09700</span> <span class="o">+</span> <span class="n">e09800</span> <span class="o">+</span> <span class="n">e09900</span> <span class="o">+</span> <span class="n">niit</span>
    <span class="n">c09200</span> <span class="o">=</span> <span class="n">othertaxes</span> <span class="o">+</span> <span class="n">tax_net_nonrefundable_credits</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">c07100</span><span class="p">,</span> <span class="n">othertaxes</span><span class="p">,</span> <span class="n">c09200</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">CTC_new</span><span class="p">(</span><span class="n">CTC_new_c</span><span class="p">,</span> <span class="n">CTC_new_rt</span><span class="p">,</span> <span class="n">CTC_new_c_under6_bonus</span><span class="p">,</span>
            <span class="n">CTC_new_ps</span><span class="p">,</span> <span class="n">CTC_new_prt</span><span class="p">,</span> <span class="n">CTC_new_for_all</span><span class="p">,</span>
            <span class="n">CTC_new_refund_limited</span><span class="p">,</span> <span class="n">CTC_new_refund_limit_payroll_rt</span><span class="p">,</span>
            <span class="n">CTC_new_refund_limited_all_payroll</span><span class="p">,</span> <span class="n">payrolltax</span><span class="p">,</span>
            <span class="n">n24</span><span class="p">,</span> <span class="n">nu06</span><span class="p">,</span> <span class="n">c00100</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">ptax_oasdi</span><span class="p">,</span> <span class="n">c09200</span><span class="p">,</span>
            <span class="n">ctc_new</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes new refundable child tax credit using specified parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n24</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">posagi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">ctc_new</span> <span class="o">=</span> <span class="n">CTC_new_c</span> <span class="o">*</span> <span class="n">n24</span> <span class="o">+</span> <span class="n">CTC_new_c_under6_bonus</span> <span class="o">*</span> <span class="n">nu06</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">CTC_new_for_all</span><span class="p">:</span>
            <span class="n">ctc_new</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">CTC_new_rt</span> <span class="o">*</span> <span class="n">posagi</span><span class="p">,</span> <span class="n">ctc_new</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">CTC_new_ps</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">posagi</span> <span class="o">&gt;</span> <span class="n">ymax</span><span class="p">:</span>
            <span class="n">ctc_new_reduced</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span>
                                  <span class="n">ctc_new</span> <span class="o">-</span> <span class="n">CTC_new_prt</span> <span class="o">*</span> <span class="p">(</span><span class="n">posagi</span> <span class="o">-</span> <span class="n">ymax</span><span class="p">))</span>
            <span class="n">ctc_new</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ctc_new</span><span class="p">,</span> <span class="n">ctc_new_reduced</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ctc_new</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">CTC_new_refund_limited</span><span class="p">:</span>
            <span class="n">refund_new</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ctc_new</span> <span class="o">-</span> <span class="n">c09200</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">CTC_new_refund_limited_all_payroll</span><span class="p">:</span>
                <span class="n">limit_new</span> <span class="o">=</span> <span class="n">CTC_new_refund_limit_payroll_rt</span> <span class="o">*</span> <span class="n">ptax_oasdi</span>
            <span class="k">if</span> <span class="n">CTC_new_refund_limited_all_payroll</span><span class="p">:</span>
                <span class="n">limit_new</span> <span class="o">=</span> <span class="n">CTC_new_refund_limit_payroll_rt</span> <span class="o">*</span> <span class="n">payrolltax</span>
            <span class="n">limited_new</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">refund_new</span> <span class="o">-</span> <span class="n">limit_new</span><span class="p">)</span>
            <span class="n">ctc_new</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ctc_new</span> <span class="o">-</span> <span class="n">limited_new</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ctc_new</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">ctc_new</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">IITAX</span><span class="p">(</span><span class="n">c59660</span><span class="p">,</span> <span class="n">c11070</span><span class="p">,</span> <span class="n">c10960</span><span class="p">,</span> <span class="n">personal_refundable_credit</span><span class="p">,</span> <span class="n">ctc_new</span><span class="p">,</span> <span class="n">rptc</span><span class="p">,</span>
          <span class="n">c09200</span><span class="p">,</span> <span class="n">payrolltax</span><span class="p">,</span>
          <span class="n">eitc</span><span class="p">,</span> <span class="n">refund</span><span class="p">,</span> <span class="n">iitax</span><span class="p">,</span> <span class="n">combined</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes final taxes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">eitc</span> <span class="o">=</span> <span class="n">c59660</span>
    <span class="n">refund</span> <span class="o">=</span> <span class="p">(</span><span class="n">eitc</span> <span class="o">+</span> <span class="n">c11070</span> <span class="o">+</span> <span class="n">c10960</span> <span class="o">+</span>
              <span class="n">personal_refundable_credit</span> <span class="o">+</span> <span class="n">ctc_new</span> <span class="o">+</span> <span class="n">rptc</span><span class="p">)</span>
    <span class="n">iitax</span> <span class="o">=</span> <span class="n">c09200</span> <span class="o">-</span> <span class="n">refund</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">iitax</span> <span class="o">+</span> <span class="n">payrolltax</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">eitc</span><span class="p">,</span> <span class="n">refund</span><span class="p">,</span> <span class="n">iitax</span><span class="p">,</span> <span class="n">combined</span><span class="p">)</span>


<div class="viewcode-block" id="Taxes"><a class="viewcode-back" href="../../api/calcfunctions.html#taxcalc.calcfunctions.Taxes">[docs]</a><span class="nd">@JIT</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">Taxes</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">tbrk_base</span><span class="p">,</span>
          <span class="n">rate1</span><span class="p">,</span> <span class="n">rate2</span><span class="p">,</span> <span class="n">rate3</span><span class="p">,</span> <span class="n">rate4</span><span class="p">,</span> <span class="n">rate5</span><span class="p">,</span> <span class="n">rate6</span><span class="p">,</span> <span class="n">rate7</span><span class="p">,</span> <span class="n">rate8</span><span class="p">,</span>
          <span class="n">tbrk1</span><span class="p">,</span> <span class="n">tbrk2</span><span class="p">,</span> <span class="n">tbrk3</span><span class="p">,</span> <span class="n">tbrk4</span><span class="p">,</span> <span class="n">tbrk5</span><span class="p">,</span> <span class="n">tbrk6</span><span class="p">,</span> <span class="n">tbrk7</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Taxes function returns tax amount given the progressive tax rate</span>
<span class="sd">    schedule specified by the rate* and (upper) tbrk* parameters and</span>
<span class="sd">    given income, filing status (MARS), and tax bracket base (tbrk_base).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tbrk_base</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">brk1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tbrk1</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tbrk_base</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">brk2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tbrk2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tbrk_base</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">brk3</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tbrk3</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tbrk_base</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">brk4</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tbrk4</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tbrk_base</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">brk5</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tbrk5</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tbrk_base</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">brk6</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tbrk6</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tbrk_base</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">brk7</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">tbrk7</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tbrk_base</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">brk1</span> <span class="o">=</span> <span class="n">tbrk1</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">brk2</span> <span class="o">=</span> <span class="n">tbrk2</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">brk3</span> <span class="o">=</span> <span class="n">tbrk3</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">brk4</span> <span class="o">=</span> <span class="n">tbrk4</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">brk5</span> <span class="o">=</span> <span class="n">tbrk5</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">brk6</span> <span class="o">=</span> <span class="n">tbrk6</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">brk7</span> <span class="o">=</span> <span class="n">tbrk7</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">rate1</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">income</span><span class="p">,</span> <span class="n">brk1</span><span class="p">)</span> <span class="o">+</span>
            <span class="n">rate2</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">brk2</span> <span class="o">-</span> <span class="n">brk1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">income</span> <span class="o">-</span> <span class="n">brk1</span><span class="p">))</span> <span class="o">+</span>
            <span class="n">rate3</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">brk3</span> <span class="o">-</span> <span class="n">brk2</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">income</span> <span class="o">-</span> <span class="n">brk2</span><span class="p">))</span> <span class="o">+</span>
            <span class="n">rate4</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">brk4</span> <span class="o">-</span> <span class="n">brk3</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">income</span> <span class="o">-</span> <span class="n">brk3</span><span class="p">))</span> <span class="o">+</span>
            <span class="n">rate5</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">brk5</span> <span class="o">-</span> <span class="n">brk4</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">income</span> <span class="o">-</span> <span class="n">brk4</span><span class="p">))</span> <span class="o">+</span>
            <span class="n">rate6</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">brk6</span> <span class="o">-</span> <span class="n">brk5</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">income</span> <span class="o">-</span> <span class="n">brk5</span><span class="p">))</span> <span class="o">+</span>
            <span class="n">rate7</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">brk7</span> <span class="o">-</span> <span class="n">brk6</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">income</span> <span class="o">-</span> <span class="n">brk6</span><span class="p">))</span> <span class="o">+</span>
            <span class="n">rate8</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">income</span> <span class="o">-</span> <span class="n">brk7</span><span class="p">))</span></div>


<div class="viewcode-block" id="ComputeBenefit"><a class="viewcode-back" href="../../api/calcfunctions.html#taxcalc.calcfunctions.ComputeBenefit">[docs]</a><span class="k">def</span> <span class="nf">ComputeBenefit</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span> <span class="n">ID_switch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the value of the benefits accrued from itemizing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># compute income tax liability with no itemized deductions allowed for</span>
    <span class="c1"># the types of itemized deductions covered under the BenefitSurtax</span>
    <span class="n">no_ID_calc</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">calc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ID_switch</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">no_ID_calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_Medical_hc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ID_switch</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">no_ID_calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_StateLocalTax_hc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ID_switch</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">no_ID_calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_RealEstate_hc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ID_switch</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
        <span class="n">no_ID_calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_Casualty_hc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ID_switch</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
        <span class="n">no_ID_calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_Miscellaneous_hc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ID_switch</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span>
        <span class="n">no_ID_calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_InterestPaid_hc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ID_switch</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>
        <span class="n">no_ID_calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_Charity_hc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.</span><span class="p">])</span>
    <span class="n">no_ID_calc</span><span class="o">.</span><span class="n">_calc_one_year</span><span class="p">()</span>  <span class="c1"># pylint: disable=protected-access</span>
    <span class="n">diff_iitax</span> <span class="o">=</span> <span class="n">no_ID_calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;iitax&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;iitax&#39;</span><span class="p">)</span>
    <span class="n">benefit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diff_iitax</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">diff_iitax</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">benefit</span></div>


<div class="viewcode-block" id="BenefitSurtax"><a class="viewcode-back" href="../../api/calcfunctions.html#taxcalc.calcfunctions.BenefitSurtax">[docs]</a><span class="k">def</span> <span class="nf">BenefitSurtax</span><span class="p">(</span><span class="n">calc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes itemized-deduction-benefit surtax and adds the surtax amount</span>
<span class="sd">    to income tax, combined tax, and surtax liabilities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitSurtax_crt&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1.</span><span class="p">:</span>
        <span class="n">ben</span> <span class="o">=</span> <span class="n">ComputeBenefit</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span>
                             <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitSurtax_Switch&#39;</span><span class="p">))</span>
        <span class="n">agi</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;c00100&#39;</span><span class="p">)</span>
        <span class="n">ben_deduct</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitSurtax_crt&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">agi</span>
        <span class="n">ben_exempt_array</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitSurtax_em&#39;</span><span class="p">)</span>
        <span class="n">ben_exempt</span> <span class="o">=</span> <span class="n">ben_exempt_array</span><span class="p">[</span><span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;MARS&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ben_dedem</span> <span class="o">=</span> <span class="n">ben_deduct</span> <span class="o">+</span> <span class="n">ben_exempt</span>
        <span class="n">ben_surtax</span> <span class="o">=</span> <span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitSurtax_trt&#39;</span><span class="p">)</span> <span class="o">*</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ben</span> <span class="o">&gt;</span> <span class="n">ben_dedem</span><span class="p">,</span> <span class="n">ben</span> <span class="o">-</span> <span class="n">ben_dedem</span><span class="p">,</span> <span class="mf">0.</span><span class="p">))</span>
        <span class="c1"># add ben_surtax to income &amp; combined taxes and to surtax subtotal</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">incarray</span><span class="p">(</span><span class="s1">&#39;iitax&#39;</span><span class="p">,</span> <span class="n">ben_surtax</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">incarray</span><span class="p">(</span><span class="s1">&#39;combined&#39;</span><span class="p">,</span> <span class="n">ben_surtax</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">incarray</span><span class="p">(</span><span class="s1">&#39;surtax&#39;</span><span class="p">,</span> <span class="n">ben_surtax</span><span class="p">)</span></div>


<div class="viewcode-block" id="BenefitLimitation"><a class="viewcode-back" href="../../api/calcfunctions.html#taxcalc.calcfunctions.BenefitLimitation">[docs]</a><span class="k">def</span> <span class="nf">BenefitLimitation</span><span class="p">(</span><span class="n">calc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits the benefits of select itemized deductions to a fraction of</span>
<span class="sd">    deductible expenses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitCap_rt&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">1.</span><span class="p">:</span>
        <span class="n">benefit</span> <span class="o">=</span> <span class="n">ComputeBenefit</span><span class="p">(</span><span class="n">calc</span><span class="p">,</span>
                                 <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitCap_Switch&#39;</span><span class="p">))</span>
        <span class="c1"># Calculate total deductible expenses under the cap</span>
        <span class="n">deduct_exps</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitCap_Switch&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># medical</span>
            <span class="n">deduct_exps</span> <span class="o">+=</span> <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;c17000&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitCap_Switch&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># statelocal</span>
            <span class="n">one_minus_hc</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_StateLocalTax_hc&#39;</span><span class="p">)</span>
            <span class="n">deduct_exps</span> <span class="o">+=</span> <span class="p">(</span><span class="n">one_minus_hc</span> <span class="o">*</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e18400_capped&#39;</span><span class="p">),</span> <span class="mf">0.</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitCap_Switch&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]:</span>  <span class="c1"># realestate</span>
            <span class="n">one_minus_hc</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_RealEstate_hc&#39;</span><span class="p">)</span>
            <span class="n">deduct_exps</span> <span class="o">+=</span> <span class="n">one_minus_hc</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;e18500_capped&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitCap_Switch&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">]:</span>  <span class="c1"># casualty</span>
            <span class="n">deduct_exps</span> <span class="o">+=</span> <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;c20500&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitCap_Switch&#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]:</span>  <span class="c1"># misc</span>
            <span class="n">deduct_exps</span> <span class="o">+=</span> <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;c20800&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitCap_Switch&#39;</span><span class="p">)[</span><span class="mi">5</span><span class="p">]:</span>  <span class="c1"># interest</span>
            <span class="n">deduct_exps</span> <span class="o">+=</span> <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;c19200&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitCap_Switch&#39;</span><span class="p">)[</span><span class="mi">6</span><span class="p">]:</span>  <span class="c1"># charity</span>
            <span class="n">deduct_exps</span> <span class="o">+=</span> <span class="n">calc</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;c19700&#39;</span><span class="p">)</span>
        <span class="c1"># Calculate cap value for itemized deductions</span>
        <span class="n">benefit_limit</span> <span class="o">=</span> <span class="n">deduct_exps</span> <span class="o">*</span> <span class="n">calc</span><span class="o">.</span><span class="n">policy_param</span><span class="p">(</span><span class="s1">&#39;ID_BenefitCap_rt&#39;</span><span class="p">)</span>
        <span class="c1"># Add the difference between the actual benefit and capped benefit</span>
        <span class="c1"># to income tax and combined tax liabilities.</span>
        <span class="n">excess_benefit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">benefit</span> <span class="o">-</span> <span class="n">benefit_limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">incarray</span><span class="p">(</span><span class="s1">&#39;iitax&#39;</span><span class="p">,</span> <span class="n">excess_benefit</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">incarray</span><span class="p">(</span><span class="s1">&#39;surtax&#39;</span><span class="p">,</span> <span class="n">excess_benefit</span><span class="p">)</span>
        <span class="n">calc</span><span class="o">.</span><span class="n">incarray</span><span class="p">(</span><span class="s1">&#39;combined&#39;</span><span class="p">,</span> <span class="n">excess_benefit</span><span class="p">)</span></div>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">FairShareTax</span><span class="p">(</span><span class="n">c00100</span><span class="p">,</span> <span class="n">MARS</span><span class="p">,</span> <span class="n">ptax_was</span><span class="p">,</span> <span class="n">setax</span><span class="p">,</span> <span class="n">ptax_amc</span><span class="p">,</span>
                 <span class="n">FST_AGI_trt</span><span class="p">,</span> <span class="n">FST_AGI_thd_lo</span><span class="p">,</span> <span class="n">FST_AGI_thd_hi</span><span class="p">,</span>
                 <span class="n">fstax</span><span class="p">,</span> <span class="n">iitax</span><span class="p">,</span> <span class="n">combined</span><span class="p">,</span> <span class="n">surtax</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes Fair Share Tax, or &quot;Buffet Rule&quot;, types of reforms.</span>

<span class="sd">    Taxpayer Characteristics</span>
<span class="sd">    ------------------------</span>

<span class="sd">    c00100 : AGI</span>

<span class="sd">    MARS : filing (marital) status</span>

<span class="sd">    ptax_was : payroll tax on wages and salaries</span>

<span class="sd">    setax : self-employment tax</span>

<span class="sd">    ptax_amc : Additional Medicare Tax on high earnings</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    fstax : Fair Share Tax amount</span>

<span class="sd">    iitax : individual income tax augmented by fstax</span>

<span class="sd">    combined : individual income tax plus payroll taxes augmented by fstax</span>

<span class="sd">    surtax : individual income tax subtotal augmented by fstax</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">FST_AGI_trt</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&gt;=</span> <span class="n">FST_AGI_thd_lo</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="n">employee_share</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ptax_was</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">setax</span> <span class="o">+</span> <span class="n">ptax_amc</span>
        <span class="n">fstax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">c00100</span> <span class="o">*</span> <span class="n">FST_AGI_trt</span> <span class="o">-</span> <span class="n">iitax</span> <span class="o">-</span> <span class="n">employee_share</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="n">thd_gap</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">FST_AGI_thd_hi</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">FST_AGI_thd_lo</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thd_gap</span> <span class="o">&gt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">c00100</span> <span class="o">&lt;</span> <span class="n">FST_AGI_thd_hi</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="n">fstax</span> <span class="o">*=</span> <span class="p">(</span><span class="n">c00100</span> <span class="o">-</span> <span class="n">FST_AGI_thd_lo</span><span class="p">[</span><span class="n">MARS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">thd_gap</span>
        <span class="n">iitax</span> <span class="o">+=</span> <span class="n">fstax</span>
        <span class="n">combined</span> <span class="o">+=</span> <span class="n">fstax</span>
        <span class="n">surtax</span> <span class="o">+=</span> <span class="n">fstax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fstax</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">fstax</span><span class="p">,</span> <span class="n">iitax</span><span class="p">,</span> <span class="n">combined</span><span class="p">,</span> <span class="n">surtax</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">LumpSumTax</span><span class="p">(</span><span class="n">DSI</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">XTOT</span><span class="p">,</span>
               <span class="n">LST</span><span class="p">,</span>
               <span class="n">lumpsum_tax</span><span class="p">,</span> <span class="n">combined</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes lump-sum tax and add it to combined taxes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">LST</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">DSI</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">lumpsum_tax</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lumpsum_tax</span> <span class="o">=</span> <span class="n">LST</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">XTOT</span><span class="p">)</span>
    <span class="n">combined</span> <span class="o">+=</span> <span class="n">lumpsum_tax</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">lumpsum_tax</span><span class="p">,</span> <span class="n">combined</span><span class="p">)</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ExpandIncome</span><span class="p">(</span><span class="n">e00200</span><span class="p">,</span> <span class="n">pencon_p</span><span class="p">,</span> <span class="n">pencon_s</span><span class="p">,</span> <span class="n">e00300</span><span class="p">,</span> <span class="n">e00400</span><span class="p">,</span> <span class="n">e00600</span><span class="p">,</span>
                 <span class="n">e00700</span><span class="p">,</span> <span class="n">e00800</span><span class="p">,</span> <span class="n">e00900</span><span class="p">,</span> <span class="n">e01100</span><span class="p">,</span> <span class="n">e01200</span><span class="p">,</span> <span class="n">e01400</span><span class="p">,</span> <span class="n">e01500</span><span class="p">,</span>
                 <span class="n">e02000</span><span class="p">,</span> <span class="n">e02100</span><span class="p">,</span> <span class="n">p22250</span><span class="p">,</span> <span class="n">p23250</span><span class="p">,</span> <span class="n">cmbtp</span><span class="p">,</span> <span class="n">ptax_was</span><span class="p">,</span>
                 <span class="n">benefit_value_total</span><span class="p">,</span> <span class="n">expanded_income</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates expanded_income from component income types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expanded_income</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">e00200</span> <span class="o">+</span>  <span class="c1"># wage and salary income net of DC pension contributions</span>
        <span class="n">pencon_p</span> <span class="o">+</span>  <span class="c1"># tax-advantaged DC pension contributions for taxpayer</span>
        <span class="n">pencon_s</span> <span class="o">+</span>  <span class="c1"># tax-advantaged DC pension contributions for spouse</span>
        <span class="n">e00300</span> <span class="o">+</span>  <span class="c1"># taxable interest income</span>
        <span class="n">e00400</span> <span class="o">+</span>  <span class="c1"># non-taxable interest income</span>
        <span class="n">e00600</span> <span class="o">+</span>  <span class="c1"># dividends</span>
        <span class="n">e00700</span> <span class="o">+</span>  <span class="c1"># state and local income tax refunds</span>
        <span class="n">e00800</span> <span class="o">+</span>  <span class="c1"># alimony received</span>
        <span class="n">e00900</span> <span class="o">+</span>  <span class="c1"># Sch C business net income/loss</span>
        <span class="n">e01100</span> <span class="o">+</span>  <span class="c1"># capital gain distributions not reported on Sch D</span>
        <span class="n">e01200</span> <span class="o">+</span>  <span class="c1"># Form 4797 other net gain/loss</span>
        <span class="n">e01400</span> <span class="o">+</span>  <span class="c1"># taxable IRA distributions</span>
        <span class="n">e01500</span> <span class="o">+</span>  <span class="c1"># total pension &amp; annuity income (including DB-plan benefits)</span>
        <span class="n">e02000</span> <span class="o">+</span>  <span class="c1"># Sch E total rental, ..., partnership, S-corp income/loss</span>
        <span class="n">e02100</span> <span class="o">+</span>  <span class="c1"># Sch F farm net income/loss</span>
        <span class="n">p22250</span> <span class="o">+</span>  <span class="c1"># Sch D: net short-term capital gain/loss</span>
        <span class="n">p23250</span> <span class="o">+</span>  <span class="c1"># Sch D: net long-term capital gain/loss</span>
        <span class="n">cmbtp</span> <span class="o">+</span>  <span class="c1"># other AMT taxable income items from Form 6251</span>
        <span class="mf">0.5</span> <span class="o">*</span> <span class="n">ptax_was</span> <span class="o">+</span>  <span class="c1"># employer share of FICA taxes on wages/salaries</span>
        <span class="n">benefit_value_total</span>  <span class="c1"># consumption value of all benefits received;</span>
        <span class="c1"># see the BenefitPrograms function in this file for details on</span>
        <span class="c1"># exactly how the benefit_value_total variable is computed</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">expanded_income</span>


<span class="nd">@iterate_jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">AfterTaxIncome</span><span class="p">(</span><span class="n">combined</span><span class="p">,</span> <span class="n">expanded_income</span><span class="p">,</span> <span class="n">aftertax_income</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates after-tax expanded income.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    combined: combined tax liability</span>
<span class="sd">    expanded_income: expanded income</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    aftertax_income: expanded_income minus combined</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aftertax_income</span> <span class="o">=</span> <span class="n">expanded_income</span> <span class="o">-</span> <span class="n">combined</span>
    <span class="k">return</span> <span class="n">aftertax_income</span>
</pre></div>

              </div>
              
        
        <div class='prev-next-bottom'>
            

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Policy Simulation Library<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>